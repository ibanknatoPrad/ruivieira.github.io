<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Rui Vieira" />
        <meta name="copyright" content="Rui Vieira" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", misc, " />

<meta property="og:title" content="MCMC performance on Substrate VM "/>
<meta property="og:url" content="./mcmc-performance-on-substrate-vm.html" />
<meta property="og:description" content="Recently I&#39;ve been following (but not very closely, I admit) the development of the GraalVM project. The project has many interesting goals (such as Project Metropolis, increased JIT performance and others). However, having dabbled with projects such as Scala native and Kotlin native, one of the aspects of GraalVM that …" />
<meta property="og:site_name" content="Rui Vieira" />
<meta property="og:article:author" content="Rui Vieira" />
<meta property="og:article:published_time" content="2018-08-02T23:05:00+01:00" />
<meta name="twitter:title" content="MCMC performance on Substrate VM ">
<meta name="twitter:description" content="Recently I&#39;ve been following (but not very closely, I admit) the development of the GraalVM project. The project has many interesting goals (such as Project Metropolis, increased JIT performance and others). However, having dabbled with projects such as Scala native and Kotlin native, one of the aspects of GraalVM that …">

        <title>MCMC performance on Substrate VM  · Rui Vieira
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/cmun-serif.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/cmun-serif-slanted.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-10507665-2', 'auto');
    ga('send', 'pageview');
</script>
        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@ruimvieira">
        <meta name="twitter:image" content="https://ruivieira.github.io/images/gibbs_jvm_native.png">

    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="./"><span class=site-name>Rui Vieira</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href=".">Home</a></li>
                            <li ><a href="./pages/about.html">About</a></li>
                            <li ><a href="./categories.html">Categories</a></li>
                            <li ><a href="./tags.html">Tags</a></li>
                            <li ><a href="./archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span6 offset2">
    <h1><a href="./mcmc-performance-on-substrate-vm.html"> MCMC performance on Substrate VM  </a></h1>
        <i>Posted on <time pubdate="pubdate" datetime="2018-08-02T23:05:00+01:00">August 2, 2018</time></i>

    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>Recently I've been following (but not very closely, I admit) the development of the <a href="https://www.graalvm.org/">GraalVM</a> project. The project has many interesting goals (such as <a href="http://openjdk.java.net/projects/metropolis/">Project Metropolis</a>, increased JIT performance and others).</p>
<p>However, having dabbled with projects such as <a href="https://github.com/scala-native/scala-native">Scala native</a> and <a href="https://kotlinlang.org/docs/reference/native-overview.html">Kotlin native</a>, one of the aspects of GraalVM that caught my attention was the <a href="https://github.com/oracle/graal/tree/master/substratevm">SubstrateVM</a>, which allegedly allows for a simple, straight-forward compilation of any Java bytecode into a native binary.
I specifically wanted to compare the performance and memory consumption of simple scientific computing tasks when using the JVM and native executables.</p>
<p>To do this, I picked two simple numerical simulations in the form of toy Gibbs samplers, in order to keep the cores busy for a while.</p>
<h2>Binomial-Beta case</h2>
<p>The first problem chosen was the one of sampling from a Beta-Binomial distribution where we have</p>
<div class="math">$$
X \sim \text{Binom}\left(n,\theta\right) \\
\theta \sim \text{B}\left(a,b\right).
$$</div>
<p>Since we know that</p>
<div class="math">$$
    \pi\left(\theta|x\right) \propto \theta^x \left(1-\theta\right)^{n-x}\theta^{a-1}\left(1-\theta\right)^{b-1},
$$</div>
<p>We calculate the joint density</p>
<div class="math">$$
p(x,\theta) = \begin{pmatrix} n \\ x \end{pmatrix} \theta^x \left(1-\theta\right)^{n-x}\frac{\Gamma\left(a+b\right)}{\Gamma(a)\Gamma(b)}\theta^{a-1}\left(1-\theta\right)^{b-1}
$$</div>
<p>The marginal distribution is a Binomial-Beta:</p>
<div class="math">$$
p\left(x\right)=\begin{pmatrix} n \\ x \end{pmatrix}\frac{\Gamma\left(a+b\right)}{\Gamma(a)\Gamma(b)}\frac{\Gamma\left(a+b\right)\Gamma\left(b+n-x\right)}{\Gamma\left(a+b+n\right)},\qquad x=0,1,\cdots,n
$$</div>
<p>.</p>
<p>The code for this simulation is available <a href="https://github.com/ruivieira/benchmark-gibbs">here</a>.</p>
<p>The project is setup so that Maven produces an assembly Jar file, since I've found that to be the easier artifact we can offer to the GraalVM's native compiler. To enable assembly Jars we add the <code>maven-assembly-plugin</code> to <code>pom.xml</code> and specify a main class. The assembly can then be produced simply by executing</p>
<div class="highlight"><pre><span></span>mvn package
</pre></div>


<p>An assembly Jar should be available in the <code>target</code> folder and named <code>benchmark-gibbs-1.0-SNAPSHOT-jar-with-dependencies.jar</code>. Both the Jar and the native executable allow to specify how many iterations the Gibbs sampler should run for (as well as the thinning factor). If nothing is specified, the default will be used, which is <span class="math">\(50000\)</span> iterations thinned by <span class="math">\(100\)</span>.</p>
<p>This particular Gibbs sampler was implemented in two variants. One variant stores the samples draws of <span class="math">\(x\)</span> and <span class="math">\(\theta\)</span> in arrays <code>double[]</code> while the other one simply calculates the Gibbs steps by using the previous value, that is <span class="math">\(x_i=f(x_{i-1},\theta_{i-1})\)</span> and then discarding the previous values. The latter has a constant memory cost in <span class="math">\(\mathcal{O}(1)\)</span> in terms of number of iterations, while the former clearly doesn't.</p>
<p>We can them proceed with the first test, first benchmarking it under the JVM by running (for both sample history variants):</p>
<div class="highlight"><pre><span></span>$ /usr/bin/time -v java -jar target/benchmark-gibbs-1.0-SNAPSHOT-jar-with-dependencies.jar store <span class="m">50000</span> <span class="m">100</span>
$ /usr/bin/time -v java -jar target/benchmark-gibbs-1.0-SNAPSHOT-jar-with-dependencies.jar nostore <span class="m">50000</span> <span class="m">100</span>
</pre></div>


<p>(It is important to note that the <code>time</code> command is the executable under <code>/usr/bin</code> and not your shell's builtin.)</p>
<p>The next step is to build the native image using GraalVM's compiler. This is also quite straight-forward and simply a matter of calling:</p>
<div class="highlight"><pre><span></span>$GRAALVM_BIN/native-image target/benchmark-gibbs-1.0-SNAPSHOT-jar-with-dependencies.jar
</pre></div>


<p>where <code>$GRAALVM_BIN</code> is simply the location where you installed the GraalVM binaries. If the compilation is successful, you should see some information about the compilation steps, such as parsing, inlining, compiling and writing the image. Finally, if using the default, you should have a native executable available in your current directory. Again, the benchmark command is similar to the JVM step, that is:</p>
<div class="highlight"><pre><span></span>$ /usr/bin/time -v ./benchmark-gibbs-1.0-SNAPSHOT-jar-with-dependencies store <span class="m">50000</span> <span class="m">100</span>
$ /usr/bin/time -v ./benchmark-gibbs-1.0-SNAPSHOT-jar-with-dependencies nostore <span class="m">50000</span> <span class="m">100</span>
</pre></div>


<p>The results from the runs which saved the sampling history on both platforms (JVM and native) were consistent as we can see from the plots below:</p>
<p><img alt="Data &lt;&gt;" src="{filename}/images/gibbs_jvm_native.png"></p>
<p>The (peak) memory consumption and execution time for each version is presented in the table below:</p>
<table class="table table-hover">
<thead>
  <tr>
    <th></th>
    <th>Time (s)</th>
    <th>Peak (Mb)</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>JVM (no sample history)</td><td>110.09</td><td>320.913</td>
  </tr>
  <tr>
    <td>native (no sample history)</td><td>130.52</td><td>273.747</td>
  </tr>
    <tr>
    <td>JVM (sample history)</td><td>112.51</td><td>324.796</td>
  </tr>
  <tr>
    <td>native (sample history)</td><td>130.62</td><td>274.239</td>
  </tr>
</tbody>
</table>

<h2>Another bivariate case</h2>
<p>The second problem chosen is another bivariate model, <a href="/a-gibbs-sampler-in-crystal.html">previously detailed</a> in this blog.
The code is included in the same repositoty as the Beta-Binomial case and the setup for the benchmarks is similar. The only step needed to run this example is to change the main class in the assemply plugin section of the <code>pom.xml</code> from <code>BinomialBeta</code> to <code>Bivariate</code>. The benchmark results are in the table below:</p>
<table class="table table-hover">
<thead>
  <tr>
    <th></th>
    <th>Time (s)</th>
    <th>Peak (Mb)</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>JVM</td><td>106.92</td><td>176.541</td>
  </tr>
  <tr>
    <td>native</td><td>121.29</td><td>273.383</td>
  </tr>
</tbody>
</table>

<p>Now, in this case, the results are much more interesting. The JVM version outperforms the native version in <em>both</em> execution time and memory consumption. I don't have an explanation for this, but if you think you have (or have any other questions) please let me know on <a href="https://mastodon.social/@ruivieira">Mastodon</a> or <a href="https://twitter.com/ruimvieira">Twitter</a>.</p>
<p>Thanks for reading!</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            
            
            <hr/>
        </div>
        <!--<section>-->
        <!--<div class="span2" style="float:right;font-size:0.9em;">-->
            <!---->
            <!--<h4>Published</h4>-->
            <!---->
            <!--<time pubdate="pubdate" datetime="2018-08-02T23:05:00+01:00">Aug 2, 2018</time>-->
            <!---->
            <!---->
            <!---->
            <!---->
            <!--<h4>Category</h4>-->
            <!--<a class="category-link" href="./categories.html#misc-ref">misc</a>-->
            <!---->
            <!---->
            <!--<h4>Contact</h4>
    <a href="#" title="My You can add links in your config file Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-you can add links in your config file sidebar-social-links"></i></a>
    <a href="#" title="My Another social link Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-another social link sidebar-social-links"></i></a>
-->
            <!---->
        <!--</div>-->
        <!--</section>-->
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>