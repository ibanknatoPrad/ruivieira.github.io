<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Rui Vieira" />
        <meta name="copyright" content="Rui Vieira" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", misc, " />

<meta property="og:title" content="Bayesian estimation of changepoints "/>
<meta property="og:url" content="./bayesian-estimation-of-changepoints.html" />
<meta property="og:description" content="A common introductory problem in Bayesian changepoint detection is the record of UK coal mining disasters from 1851 to 1962. More information can be found in Carlin, Gelfand and Smith (1992). As we can see from the plot below, the number of yearly disasters ranges from 0 to 6 and …" />
<meta property="og:site_name" content="Rui Vieira" />
<meta property="og:article:author" content="Rui Vieira" />
<meta property="og:article:published_time" content="2016-11-29T20:02:00+00:00" />
<meta name="twitter:title" content="Bayesian estimation of changepoints ">
<meta name="twitter:description" content="A common introductory problem in Bayesian changepoint detection is the record of UK coal mining disasters from 1851 to 1962. More information can be found in Carlin, Gelfand and Smith (1992). As we can see from the plot below, the number of yearly disasters ranges from 0 to 6 and …">

        <title>Bayesian estimation of changepoints  · Rui Vieira
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/cmun-serif.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/cmun-serif-slanted.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-10507665-2', 'auto');
    ga('send', 'pageview');
</script>
        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@ruimvieira">

    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="./"><span class=site-name>Rui Vieira</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href=".">Home</a></li>
                            <li ><a href="./pages/about.html">About</a></li>
                            <li ><a href="./categories.html">Categories</a></li>
                            <li ><a href="./tags.html">Tags</a></li>
                            <li ><a href="./archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span6 offset2">
    <h1><a href="./bayesian-estimation-of-changepoints.html"> Bayesian estimation of changepoints  </a></h1>
        <i>Posted on <time pubdate="pubdate" datetime="2016-11-29T20:02:00+00:00">November 29, 2016</time></i>

    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>A common introductory problem in Bayesian changepoint detection is the record of UK coal
mining disasters from 1851 to 1962. More information can be found in
<a href="http://www.jstor.org/stable/2347570">Carlin, Gelfand and Smith</a> (1992).
As we can see from the plot below, the number of yearly
disasters ranges from 0 to 6 and we will assume that at some point within this time 
range a change in the accident rate has occured.</p>
<p><img alt="Data &lt;&gt;" src="{filename}/images/coal_disasters_data.png"></p>
<p>The number of yearly disasters can be modelled as a Poisson with a unknown rate depending
on the changepoint <span class="math">\(k\)</span>:</p>
<div class="math">$$
y_t \sim \text{Po}\left(\rho\right),\qquad \rho = \begin{cases}
  \mu, &amp; \text{if}\ t=1,2,\dots,k \\
  \lambda, &amp; \text{if}\ t = k +1, k + 2, \dots,m 
\end{cases}
$$</div>
<p>Our objective is to estimate in which year the change occurs (the changepoint <span class="math">\(k\)</span>) and
the acident rate before (<span class="math">\(\mu\)</span>) and after (<span class="math">\(\lambda\)</span>) the changepoint amounting to the parameter 
set <span class="math">\(\Phi = \left\lbrace\mu,\lambda,k\right\rbrace\)</span>. 
We will use <a href="https://crystal-lang.org/">Crystal</a>
(with <a href="https://github.com/ruivieira/crystal-gsl">crystal-gsl</a>) 
to perform the estimation.</p>
<p>We start by placing independent priors on the parameters:</p>
<ul>
<li><span class="math">\(k \sim \mathcal{U}\left(0, m\right)\)</span></li>
<li><span class="math">\(\mu \sim \mathcal{G}\left(a_1, b_1\right)\)</span></li>
<li><span class="math">\(\lambda \sim \mathcal{G}\left(a_2, b_2\right)\)</span></li>
</ul>
<p>For the remainder we'll set <span class="math">\(a_1=a_2=0.5\)</span>, <span class="math">\(c_1=c_2=0\)</span> and <span class="math">\(d_1=d_2=1\)</span>.
The joint posterior of <span class="math">\(\Phi\)</span> is then:</p>
<div class="math">$$
\pi\left(\Phi|Y\right) \propto p\left(Y|\Phi\right) \pi\left(k\right) \pi\left(\mu\right) \pi\left(\lambda\right),
$$</div>
<p>where the likelihood is</p>
<div class="math">$$
\begin{align}
p\left(Y|\Phi\right) &amp;= \prod_{i=1}^{k} p\left(y_i|\mu,k\right) \prod_{i=k+1}^{m} p\left(y_i|\lambda,k\right) \\
&amp;= \prod_{i=1}^{k} \frac{\mu^{y_i}e^{-\mu}}{y_i!} \prod_{i=k+1}^{m} \frac{\lambda^{y_i}e^{-\lambda}}{y_i!}.
\end{align}
$$</div>
<p>As such, the full joint posterior can be written as:</p>
<div class="math">$$
\begin{align}
\pi\left(\Phi|Y\right) &amp;\propto 
\prod_{i=1}^{k} \frac{\mu^{y_i}e^{-\mu}}{y_i!} 
\prod_{i=k+1}^{m} \frac{\lambda^{y_i}e^{-\lambda}}{y_i!}
\left(\mu^{a_1-1} e^{-\mu b_1}\right)
\left(\lambda^{a_2-1} e^{-\lambda b_2}\right)
\frac{1}{m} \\
&amp;= \mu^{a_1 + \sum_{1}^{k}y_i - 1}e^{-\mu\left(k+b_1\right)}
\lambda^{a_2 + \sum_{k+1}^{m}y_i - 1}e^{-\lambda\left(m-k+b_2\right)}
\end{align}.
$$</div>
<p>It follows that the full conditionals are, for <span class="math">\(\mu\)</span>:</p>
<div class="math">$$
\begin{align}
\pi\left(\mu|\lambda,k,Y\right) &amp;\propto \mu^{a_1 + \sum_{i=1}^{k}y_i-1}e^{-\mu\left(k+b_1\right)} \\
&amp;= \mathcal{G}\left(a_1+\sum_{i=1}^{k}y_i, k + b_1\right)
\end{align}
$$</div>
<p>We can define the <span class="math">\(\mu\)</span> update as:</p>
<div class="highlight"><pre><span></span>def mu_update(data : Array(Int), k : Int, b1 : Float64) : Float64
Gamma.sample(0.5 + data[0..k].sum, k + b1)
end
</pre></div>


<p>The full conditional for <span class="math">\(\lambda\)</span> is:</p>
<div class="math">$$
\begin{align}
\pi\left(\lambda|\mu,k,Y\right) &amp;\propto \lambda^{a_2 + \sum_{i=k+1}^{m}y_i-1}e^{-\lambda\left(m-k+b_2\right)} \\
&amp;= \mathcal{G}\left(a_2+\sum_{i=k+1}^{m}y_i, m - k + b_2\right),
\end{align}
$$</div>
<p>which we implement as:</p>
<div class="highlight"><pre><span></span>def lambda_update(data : Array(Int), k : Int, b2 : Float64) : Float64
Gamma.sample(0.5 + data[(k+1)..M].sum, M - k + b2)
end
</pre></div>


<p>The next step is to take</p>
<div class="math">$$
\begin{align}
b_1 &amp;\sim \mathcal{G}\left(a_1 + c_1,\mu + d_1\right) \\
b_2 &amp;\sim \mathcal{G}\left(a_2 + c_2,\lambda + d_2\right),
\end{align}
$$</div>
<p>which we will implement as:</p>
<div class="highlight"><pre><span></span>def b1_update(mu : Float64) : Float64
Gamma.sample(0.5, mu + 1.0)
end

def b2_update(lambda : Float64) : Float64
Gamma.sample(0.5, lambda + 1.0)
end
</pre></div>


<p>And finally we choose the next year, <span class="math">\(k\)</span>, according to</p>
<div class="math">$$
p\left(k|Y,\Phi\right)=\frac{L\left(Y|\Phi\right)}{\sum_{k^{\prime}} L\left(Y|\Phi^{\prime}\right)}
$$</div>
<p>where</p>
<div class="math">$$
L\left(Y|\Phi\right) = e^{\left(\lambda-\mu\right)k}\left(\frac{\mu}{\lambda}\right)^{\sum_i^k y_i}
$$</div>
<p>implemented as</p>
<div class="highlight"><pre><span></span>def l(data : Array(Int), k : Int, lambda : Float64, mu : Float64) : Float64
Math::E**((lambda - mu)*k) * (mu / lambda)**(data[0..k].sum)
end
</pre></div>


<p>So, let's start by writing our initials conditions:</p>
<div class="highlight"><pre><span></span>iterations = 100000

b1 = 1.0
b2 = 1.0

M = data.size # number of data points

# parameter storage
mus = Array(Float64).new(iterations, 0.0)
lambdas = Array(Float64).new(iterations, 0.0)
ks = Array(Int32).new(iterations, 0)
</pre></div>


<p>We can then cast the priors:</p>
<div class="highlight"><pre><span></span>mus[0] = Gamma.sample(0.5, b1)
lambdas[0] = Gamma.sample(0.5, b2)
ks[0] = Random.new.rand(M)
</pre></div>


<p>And define the main body of our Gibbs sampler:</p>
<div class="highlight"><pre><span></span>(1...iterations).map { |i|

k = ks[i-1]

mus[i] = mu_update(data, k, b1)
lambdas[i] = lambda_update(data, k, b2)

b1 = b1_update(mus[i])
b2 = b2_update(lambdas[i])

ks[i] = Multinomial.sample((0...M).map { |kk| 
  l(data, kk, lambdas[i], mus[i])
})

}
</pre></div>


<p>Looking at the results, we see that the mean value of <span class="math">\(k\)</span> is 38.761, which seems
to indicate that the change in accident rates occured somewhere near <span class="math">\(1850+38.761\approx 1889\)</span>.
We can visually check this by looking at the graph below. Also plotted are the density for the accident
rates before (<span class="math">\(\mu\)</span>) and after (<span class="math">\(\lambda\)</span>) the change.</p>
<div class="row text-center">
<div class="col-xs-6">
  <img src="/images/coal_disasters_years_gibbs.png" width='100%'>
</div>
<div class="col-xs-6">
  <img src="/images/coal_disasters_mu_lambda_gibbs.png" width='100%'>
</div>
</div>

<p>Of course, one the main advantages of implementing the solution in Crystal
is not only the boilerplate-free code, but the execution speed. Compared to
an equivalent implementation in <code>R</code> the Crystal code executed roughly
17 times faster.</p>
<table class="table table-hover">
<thead>
  <tr>
    <th>Language</th>
    <th>Time (s)</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>R</td><td>58.678</td>
  </tr>
  <tr>
    <td>Crystal</td><td>3.587</td>
  </tr>
</tbody>
</table>

<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            
            
            <hr/>
        </div>
        <!--<section>-->
        <!--<div class="span2" style="float:right;font-size:0.9em;">-->
            <!---->
            <!--<h4>Published</h4>-->
            <!---->
            <!--<time pubdate="pubdate" datetime="2016-11-29T20:02:00+00:00">Nov 29, 2016</time>-->
            <!---->
            <!---->
            <!---->
            <!---->
            <!--<h4>Category</h4>-->
            <!--<a class="category-link" href="./categories.html#misc-ref">misc</a>-->
            <!---->
            <!---->
            <!--<h4>Contact</h4>
    <a href="#" title="My You can add links in your config file Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-you can add links in your config file sidebar-social-links"></i></a>
    <a href="#" title="My Another social link Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-another social link sidebar-social-links"></i></a>
-->
            <!---->
        <!--</div>-->
        <!--</section>-->
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>