<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Rui Vieira" />
        <meta name="copyright" content="Rui Vieira" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", misc, " />

<meta property="og:title" content="A simple Python benchmark exercise "/>
<meta property="og:url" content="./a-simple-python-benchmark-exercise.html" />
<meta property="og:description" content="Recently when discussing the Crystal language and specifically the Gibbs sample blog post with a colleague, he mentioned that the Python benchmark numbers looked a bit off and not consistent with his experience of numerical programming in Python. To recall the numbers: Language Time (s) R364.8 Python144 …" />
<meta property="og:site_name" content="Rui Vieira" />
<meta property="og:article:author" content="Rui Vieira" />
<meta property="og:article:published_time" content="2018-04-22T15:21:00+01:00" />
<meta name="twitter:title" content="A simple Python benchmark exercise ">
<meta name="twitter:description" content="Recently when discussing the Crystal language and specifically the Gibbs sample blog post with a colleague, he mentioned that the Python benchmark numbers looked a bit off and not consistent with his experience of numerical programming in Python. To recall the numbers: Language Time (s) R364.8 Python144 …">

        <title>A simple Python benchmark exercise  · Rui Vieira
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/cmun-serif.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/cmun-serif-slanted.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-10507665-2', 'auto');
    ga('send', 'pageview');
</script>
        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@ruimvieira">

    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="./"><span class=site-name>Rui Vieira</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href=".">Home</a></li>
                            <li ><a href="./pages/about.html">About</a></li>
                            <li ><a href="./categories.html">Categories</a></li>
                            <li ><a href="./tags.html">Tags</a></li>
                            <li ><a href="./archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span6 offset2">
    <h1><a href="./a-simple-python-benchmark-exercise.html"> A simple Python benchmark exercise  </a></h1>
        <i>Posted on <time pubdate="pubdate" datetime="2018-04-22T15:21:00+01:00">April 22, 2018</time></i>

    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>Recently when discussing the Crystal language and
specifically the <a href="https://ruivieira.github.io/a-gibbs-sampler-in-crystal.html">Gibbs sample blog post</a> with a colleague, he mentioned that the Python benchmark
numbers looked a bit off and not consistent with his experience of numerical
programming in Python.</p>
<p>To recall the numbers:</p>
<table class="table table-hover">
<thead>
  <tr>
    <th>Language</th>
    <th>Time (s)</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>R</td><td>364.8</td>
  </tr>
  <tr>
    <td>Python</td><td>144.0</td>
  </tr>
  <tr>
    <td>Scala</td><td>9.896</td>
  </tr>
  <tr>
    <td>Crystal</td><td>5.171</td>
  </tr>
  <tr>
    <td>C</td><td>5.038</td>
  </tr>
</tbody>
</table>

<p>To have a better understanding of what is happening, I've decided to profile and benchmark that code (running on Python 3.6).
The code is the following:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">gibbs</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">thin</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Iter  x  y&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thin</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gammavariate</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">gibbs</span><span class="p">()</span>
</pre></div>


<p>Profiling this code with <code>cProfile</code> gives the following results:</p>
<table class="table table-hover">
<thead>
  <tr>
    <th>Name</th>
    <th>Call count</th>
    <th>Time (ms)</th>
    <th>Percentage</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>gammavariate</td>
    <td>50000000</td>
    <td>141267</td>
    <td>52.1%</td>
  </tr>
  <tr>
    <td>gauss</td>
    <td>50000000</td>
    <td>65689</td>
    <td>24.2%</td>
  </tr>
  <tr>
    <td>&ltbuilt-in method math.log&gt</td>
    <td>116628436</td>
    <td>18825</td>
    <td>6.9%</td>
  </tr>
  <tr>
    <td>&ltmethod 'random' of '_random.Random' objects&gt</td>
    <td>170239973</td>
    <td>17155</td>
    <td>6.3%</td>
  </tr>
  <tr>
    <td>&ltbuilt-in method math.sqrt&gt</td>
    <td> 125000000 </td>
    <td> 12352 </td>
    <td>4.6%</td>
  </tr>
    <tr>
    <td>&ltbuilt-in method math.exp&gt</td>
    <td> 60119980 </td>
    <td> 7276 </td>
    <td>2.7%</td>
  </tr>
   <tr>
    <td>&ltbuilt-in method math.cos&gt</td>
    <td> 25000000 </td>
    <td> 3338 </td>
    <td>1.2%</td>
  </tr>
   <tr>
    <td>&ltbuilt-in method math.sin&gt</td>
    <td> 25000000 </td>
    <td> 3336 </td>
    <td>1.2%</td>
  </tr>
<tr>
    <td>&ltbuilt-in method builtins.print&gt</td>
    <td> 50001 </td>
    <td> 1030 </td>
    <td>0.4%</td>
  </tr>
  <tr>
    <td>gibbs.py</td>
    <td> 1 </td>
    <td> 271396 </td>
    <td>100.0%</td>
  </tr>
</tbody>
</table>

<p>The results look different than the original ones on account of being performed on a different machine. However, we will just look into the relative code performance between different implementations and whether the code itself has room for optimisation.</p>
<p>Surprisingly, the console I/O took a much smaller proportion of the execution time than I expected (0.4%).
On the other hand, as expected, the bulk of the execution time is spent on the <code>gammavariate</code> and <code>gauss</code> methods.
These methods, however, are provided by the Python's standard library <code>random</code>, which underneath makes heavy usage of <code>C</code> code (mainly by <a href="https://github.com/python/cpython/blob/master/Lib/random.py#L35">usage</a> of the <code>random()</code> function). </p>
<p>For the second run of the code, I've decided to use <code>numpy</code> to sample from the Gamma and Normal distributions. The new code, <code>gibbs_np.py</code>, is provided below.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">gibbs</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">thin</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Iter  x  y&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thin</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">gibbs</span><span class="p">()</span>
</pre></div>


<p>We can see from the plots below that the results from both modules are identical.</p>
<p><img alt="Gibbs &lt;&gt;" src="./images/gibbs_modules.png"></p>
<p>The profiling results for the <code>numpy</code> version were:</p>
<table class="table table-hover">
<thead>
  <tr>
    <th>Name</th>
    <th>Call count</th>
    <th>Time (ms)</th>
    <th>Percentage</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td>&ltmethod 'gamma' of 'mtrand.RandomState' objects&gt</td>
    <td> 50000000 </td>
    <td> 121211 </td>
    <td>45.8%</td>
  </tr>
  <tr>
    <td>&ltmethod 'normal' of 'mtrand.RandomState' objects&gt</td>
    <td> 50000000 </td>
    <td> 83092 </td>
    <td>31.4%</td>
  </tr>
  <tr>
    <td>&ltbuilt-in method math.sqrt&gt</td>
    <td> 50000000 </td>
    <td> 6127 </td>
    <td>2.3%</td>
  </tr>

<tr>
    <td>&ltbuilt-in method builtins.print&gt</td>
    <td> 50001 </td>
    <td> 920 </td>
    <td>0.3%</td>
  </tr>
  <tr>
    <td>gibbs_np.py</td>
    <td> 1 </td>
    <td> 264420 </td>
    <td>100.0%</td>
  </tr>
</tbody>
</table>

<p>A few interesting results from this benchmark were the fact that using <code>numpy</code> or <code>random</code> didn't make much difference overall (264.4 and 271.3 seconds, respectively).
This is despite the fact that, apparently, the Gamma sampling seems to perform better in <code>numpy</code> but the Normal sampling seems to be faster in the <code>random</code> library.
You will notice that we've still used Python's built-in <code>math.sqrt</code> since it is known that for scalar usage it out-performs <code>numpy</code>'s equivalent.</p>
<p>Unfortunately, in my view, we are just witnessing a fact of life: <em>Python is not the best language for number crunching</em>.</p>
<p>Since the bulk of the computational time, as we've seen, is due to the sampling of the Normal and Gamma distributions, it is clear that in our code there is little room for optimisation except the sampling methods themselves.</p>
<p>A few possible solutions would be to:</p>
<ul>
<li>Convert the code to <code>Cython</code></li>
<li>Use FFI to call a highly optimised native library which provides Gamma and Normal distributions (such as <a href="https://www.gnu.org/software/gsl/">GSL</a>)</li>
</ul>
<p>Nevertheless, personally I still find Python a great language for quick prototyping of algorithms and with an excellent scientific computing libraries ecosystem. Keep on <em>Pythoning</em>.</p>
            
            
            <hr/>
        </div>
        <!--<section>-->
        <!--<div class="span2" style="float:right;font-size:0.9em;">-->
            <!---->
            <!--<h4>Published</h4>-->
            <!---->
            <!--<time pubdate="pubdate" datetime="2018-04-22T15:21:00+01:00">Apr 22, 2018</time>-->
            <!---->
            <!---->
            <!---->
            <!---->
            <!--<h4>Category</h4>-->
            <!--<a class="category-link" href="./categories.html#misc-ref">misc</a>-->
            <!---->
            <!---->
            <!--<h4>Contact</h4>
    <a href="#" title="My You can add links in your config file Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-you can add links in your config file sidebar-social-links"></i></a>
    <a href="#" title="My Another social link Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-another social link sidebar-social-links"></i></a>
-->
            <!---->
        <!--</div>-->
        <!--</section>-->
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>