<!DOCTYPE html>
<head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">

        
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>

        
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
                onload="renderMathInElement(document.body);"></script>

        <link href="https://fonts.googleapis.com/css?family=Nunito:400,300i,800&display=swap" rel="stylesheet" />
        <style>
                @font-face {
                        font-family: JuliaMono-Regular;
                        src: url("https://cdn.jsdelivr.net/gh/cormullion/juliamono/webfonts/JuliaMono-Regular.woff2");
                }
                body {
                        font-family: Nunito;
                        font-size: 13pt;
                        color: #1b2d45;
                }
                #content {
                        max-width: 40rem;
                        padding: 2rem;
                        margin: auto;
                }
                #sidebar {
                   position: absolute;
                        top: 0;
                        left: 0;
                        max-width: 16rem;
                        margin-left: 3rem;
                        margin-top: 3rem;
                }
                h1, h2, h3, h4, h5, h6 {
                        color: #00214d;
                }
                h1 {
                        font-size: 200%;
                }

                h2 {
                        font-size: 167%;
                }
                h3 {
                        font-size: 133%;
                        font-weight: normal;
                }
                pre {
                        background-color: #eee !important;
                        overflow-x: scroll;
                        font-family: JuliaMono-Regular, monospace;
                        font-size: 75%;
                        padding: 1rem;
                }
                code {
                        background-color: #eee !important;
                        font-family: JuliaMono-Regular, monospace;
                        font-size: 75%;
                }
                img {
                        max-width: 100%;
                        margin-top: 1rem;
                        margin-bottom: 1rem;
                }
                .katex { font-size: 1em !important;}
                .footer {
                        margin-top: 3rem;
                        font-size: 0.75rem;
                        color: #ccc;
                }
                .cc-symbol {
                        font-size: 1rem;
                }
                a, a:visited {
                         
                         
                        color: #ff5470;
                        padding: 1px;
                        border-radius: 2px;
                        text-decoration: none;
                }
                a.footnote-ref {
                    font-size: 0.9rem;
                }
                a.footnote-ref::before {
                    content: "[";
                }
                a.footnote-ref::after {
                    content: "]";
                }

                a:hover {
                        background-color: #ff5470;
                        color: #fff;
                }
                a[href^="https://"],
                a[href^="http://"] {
                        text-decoration: underline;
                }

                a[href^="https://"]:after,
                a[href^="http://"]:after {
                        content: "\2609";
                        text-decoration: none !important;
                }
        </style>
        <title>ruivieira.dev - Containerised Streaming Data Generation using State-Space Models</title>
    <script type="application/javascript">
        var doNotTrack = false;
        if (!doNotTrack) {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-10507665-2', 'auto');

            ga('send', 'pageview');
        }
    </script>
</head>
<body>

<div id="sidebar">
        
            <h2>Contents</h2>
            <ul>
            
                <li><a href="#structure">Structure</a></li>
            
                <li><a href="#observations">Observations</a></li>
            
                <li><a href="#composite-model">Composite model</a></li>
            
                <li><a href="#setting-up-the-generator">Setting up the generator</a></li>
            
            </ul>
        
        
                <h2>Backlinks</h2>

                <ul>
                        
                                <li><a href="index.html">index</a><sup>&#5833</sup></li>
                        
                    <li><a href="/content.html">content</a><sup>&#5833</sup></li>

                </ul>
        
    <div class="footer">
        modified 1608159526
    </div>

</div>

<div id="content">
    <h1 id="containerised-streaming-data-generation-using-state-space-models">Containerised Streaming Data Generation using State-Space Models</h1>
<p>To prototype and test almost any application some type of input data is needed. Getting the right data can be difficult for several reasons, including strict licenses, a considerable amount of data engineering to shape the data to our requirements and the setup of dedicated data producers. Additionally, in modern applications, we are often interested in realtime/streaming and distributed processing of data with platforms such as <a href="https://kafka.apache.org/">Apache Kafka</a> and <a href="https://spark.apache.org/">Apache Spark</a> and deployment in a cloud environment like <a href="https://www.openshift.com/">OpenShift</a> with tools such as <a href="https://radanalytics.io/">oshinko</a>.</p>
<p>Simulating data is not trivial, since we might want to capture complex characteristic to evaluate our algorithms in conditions similar to the real world.<br />
In this post I'll introduce a tool, <a href="https://github.com/ruivieira/timeseries-mock">timeseries-mock</a>, which allows for a simple, containerised deployment of a data simulator along with some of the theory behind the data generation.</p>
<h1 id="state-space-models">State-space models</h1>
<p>A common way of modelling these patterns is to use state-space models (SSM). SSMs can be divided into a model and a observation structure.</p>
<p><span class="math display">\[Y_t|\theta_t,\Phi \sim f\left(y_t|\theta_t,\Phi_t\right) \\
\theta_t|\theta_{t-1},\Phi_t \sim g\left(\theta_t|\theta_{t-1},\Phi_t\right).
\]</span></p>
<p><img src="./images/ssm/ssm_diagram.png" alt="" /></p>
<p>It is clear from the above that the state possesses a Markovian nature. The state at time <span class="math inline">\(t\)</span>, <span class="math inline">\(\theta_t\)</span> will on depend on the previous value, <span class="math inline">\(\theta_{t-1}\)</span> and an observation at time <span class="math inline">\(t\)</span>, <span class="math inline">\(y_t\)</span> will only depend on the current state, <span class="math inline">\(\theta_t\)</span>, that is:</p>
<p><span class="math display">\[p\left(\theta_{t}|\theta_{0:t-1},y_{0:t-1}\right)=p\left(\theta_{t}|\theta_{t-1}\right) \\
p\left(\theta_{t-1}|\theta_{t:T},y_{t:T}\right)=p\left(\theta_{t-1}|\theta_{t}\right) \\
p\left(y_{t}|\theta_{0:t},y_{0:t-1}\right)=p\left(y_{t}|\theta_{t}\right).
\]</span></p>
<p>In this post we will focus on a specific instance of SSMs, namely Dynamic Generalised Linear Models (DGLMs). If you want a deeper theoretical analysis of DGLMs I strongly recommend Mike West and Jeff Harrison's &quot;<a href="https://www.springer.com/gb/book/9780387947259">Bayesian Forecasting and Dynamic Models</a>&quot; (1997).<br />
In DGLMs, the observation follows a distribution from the exponential family, <span class="math inline">\(E\left(\cdot\right)\)</span> such, that</p>
<p><span class="math display">\[Y_t|\theta_t,\Phi \sim E\left(\eta_t,\Phi\right) \\
\eta_t|\theta_t = L\left(\mathsf{F}^T \theta_t\right)
\]</span></p>
<p>where <span class="math inline">\(L\left(\cdot\right)\)</span> is the linear predictor and the state evolves according to a multivariate normal (MVN) distribution:</p>
<p><span class="math display">\[\theta_t \sim \mathcal{N}\left(\theta_t;\mathsf{G}\theta_{t-1},\mathsf{W}\right)
\]</span></p>
<h2 id="structure">Structure</h2>
<p>The fundamental way in which <code>timeseries-mock</code> works is by specifying the underlying structure and observational model in a YAML configuration file. In the following sections we will look at the options available in terms of structural and observational components and look at how to represent them. As we've seen from (5), the structure will allows us to define the underlying patterns of the state evolution <span class="math inline">\(\lbrace \theta_1, \theta_2, \cdots, \theta_t\rbrace\)</span>. One of the advantages of DGLMs is the ability to compose several simpler components into a single complex structure. We will then look at some of these &quot;fundamental&quot; components.</p>
<h3 id="mean">Mean</h3>
<p>An underlying mean component will represent a random-walk scalar state which can be specified in the configuration file by</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">1.5</span><span style="color:#bbb">
</span></pre><p>In this case <code>start</code> will correspond the mean of the state prior, <span class="math inline">\(m_0\)</span>, and <code>noise</code> will correspond to the prior's variance, <span class="math inline">\(\tau^2\)</span>, that is</p>
<p><span class="math display">\[\theta_0 \sim \mathcal{N}\left(m_0, \tau^2\right).
\]</span></p>
<p>In the figure below we can see the above configuration for, respectively, a higher and lower value of <code>noise</code>.</p>
<p><img src="./images/ssm/lc.png" alt="" /></p>
<h3 id="seasonality">Seasonality</h3>
<p>Seasonality is represented by Fourier components. A Fourier component can be completely specified by providing the <code>period</code>, <code>start</code>, <code>noise</code> and <code>harmonics</code>.<br />
The <code>start</code> and <code>noise</code> parameters are analogous to the mean components we saw previously.<br />
The <code>period</code> parameter refers to how long does it take for the cyclical pattern to repeat. This is done relatively to your time-point interval, such that</p>
<p><span class="math display">\[P = p_{\text{fourier}}\cdot p_{\text{stream}}.
\]</span></p>
<p>That is, if your stream's rate is one observation every 100 milliseconds, <span class="math inline">\(p_{\text{stream}}=0.1\)</span>, and the harmonic's period is 2000, <span class="math inline">\(p_{\text{fourier}}=1000\)</span>, then the seasonal component will repeat every <span class="math inline">\(200\)</span> seconds. The configuration example</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">200</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">harmonics</span>:<span style="color:#bbb"> </span><span style="color:#099">5</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.7</span><span style="color:#bbb">
</span></pre><p>will create a sequence of state vectors <span class="math inline">\(\boldsymbol{\theta}_{0:T}\)</span> with five components, such that:</p>
<p><span class="math display">\[\boldsymbol{\theta}_t = \lbrace\theta_{1,t},\cdots,\theta_{5,t}\rbrace.
\]</span></p>
<p>In this example, <code>period</code> refers to the number of time-points for each cycle's repetition and <code>harmonics</code> to the number of Fourier harmonics used. &quot;Simpler&quot; cyclic patterns usually require less harmonics. In the figure below we show on the lowest and highest frequency harmonics, on the left and right respectively.</p>
<p><img src="./images/ssm/fourier.png" alt="" /></p>
<h3 id="ar-p">AR-<em>p</em></h3>
<p>An AR(<span class="math inline">\(p\)</span>) (Auto-Regressive) component can be specified using the directives:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>arma<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">coefficients</span>:<span style="color:#bbb"> </span><span style="color:#099">0.1</span>,<span style="color:#099">0.3</span>,<span style="color:#099">0.15</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.5</span><span style="color:#bbb">
</span></pre><p>In the above example we would be creating an AR(3) component, with respective coefficients <span class="math inline">\(\phi=\lbrace 0.1,0.3,0.15 \rbrace\)</span>. These coefficients will take part of the state model as</p>
<p><span class="math display">\[\mathsf{G} = \begin{bmatrix}
\phi_1 & \phi_2 & \cdots & \phi_{p-1} & \phi_p \\
1 & 0 & \cdots & 0 & 0 \\
\vdots & & \ddots & \vdots & \vdots \\
0 & \cdots & 0 & 1 & 0
\end{bmatrix}
\]</span></p>
<p>In the following plots we show respectively the first and second component of the AR(3) state vector.</p>
<p><img src="./images/ssm/arma3.png" alt="" /></p>
<h3 id="composing">Composing</h3>
<p>Structural composition of DGLM structures amounts to the individual composition of the state covariance matrix and state/observational evolution matrices such that:</p>
<p><span class="math display">\[\mathsf{F}^T = \begin{bmatrix}\mathsf{F}_1 &amp; \mathsf{F}_2 &amp; \dots \mathsf{F}_i\end{bmatrix}^T \\
\mathsf{G} = \text{blockdiag}\left(\mathsf{G}_1, \mathsf{G}_2, \dots, \mathsf{G}_i\right) \\
\mathsf{W} = \text{blockdiag}\left(\mathsf{W}_1, \mathsf{W}_2, \dots, \mathsf{W}_i\right)
\]</span></p>
<p>To express the composition of structures in the YAML configuration, we simply enumerate the separate components under the <code>structure</code> key. As as example, to compose the previous <code>mean</code> and <code>seasonal</code> components, we would simply write:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">1.5</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">200</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">harmonics</span>:<span style="color:#bbb"> </span><span style="color:#099">5</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.7</span><span style="color:#bbb">
</span></pre><p>This would create a structure containing both an underlying mean <em>and</em> a seasonal component.</p>
<h2 id="observations">Observations</h2>
<p>As we have seen from (3) that an observational model can be coupled with a structure to complete the DGLM specification. In the following sections we will look at some example observational models and in which situations they might be useful.</p>
<h3 id="continuous">Continuous</h3>
<p>Continuous observations are useful to model real valued data such as stock prices, temperature readings, <em>etc.</em> This can be achieved by specifying the observational component as a Gaussian distribution such that:</p>
<p><span class="math display">\[Y_t|\Phi \sim \mathcal{N}\left(y_t|\eta_t, \mathsf{W}\right).
\]</span></p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>continuous<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">1.5</span><span style="color:#bbb">
</span></pre><p>The following plot shows the coupling of the structure used in the <code>mean</code> section with the continuous (example above) observational model.</p>
<p><img src="./images/ssm/continous.png" alt="" /></p>
<h3 id="discrete">Discrete</h3>
<p>Discrete observations, sometimes referred as &quot;count data&quot;, can be used to model integer quantities. This can be achieved by using a Poisson distribution in the observational model, such that:</p>
<p><span class="math display">\[Y_t|\Phi \sim \text{Po}\left(y_t|\eta_t\right)
\]</span></p>
<p>An example configuration would be:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>discrete<span style="color:#bbb">
</span></pre><p>In this case we will use the previous ARMA(3) structure example and couple it with a discrete observational model. The result is shown in the plot below:</p>
<p><img src="./images/ssm/discrete.png" alt="" /></p>
<h3 id="categorical">Categorical</h3>
<p>In the categorical case, we model the observations according to a binomial distribution, such that</p>
<p><span class="math display">\[Y_t \sim \text{Bin}\left(y_t|\eta_t,r\right),
\]</span></p>
<p>where <span class="math inline">\(r\)</span> represents the number of categories. A typical example would be the case where <span class="math inline">\(r=1\)</span> which would represent a binary outcome (0 or 1). The following configuration implements this very case:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>categorical<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">categories</span>:<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></pre><p>We can see in the plot below (<em>states on the left, observations on the right</em>) a realisation of this stream, when using the previous seasonal example structure.</p>
<p><img src="./images/ssm/categorical.png" alt="" /></p>
<p>Often, when simulating a data stream, we might be interested in the category labels themselves, rather than a numerical value. The generator allows to pass directly a list of labels and output the labelled observations. Let's assume we wanted to generate a stream of random DNA nucleotides (C, T, A and G). The generator allows to pass the labels directly and output the direct mapping between observations and label, that is:</p>
<p><span class="math display">\[y_t: \lbrace 0, 1, 2, 3 \rbrace \mapsto \lbrace\text{C, T, A, G}\rbrace
\]</span></p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>categorical<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">values</span>:<span style="color:#bbb"> </span>C,T,A,G<span style="color:#bbb">
</span></pre><p>Using the same seasonal structure and observation model as above, the output would then be:</p>
<p><img src="./images/ssm/categorical_nucleotides.png" alt="" /></p>
<h2 id="composite-model">Composite model</h2>
<p>In a real-world scenario we are interested in simulating multivariate data and that comprises of different observational models. For instance, combining observation components from categorical, continuous, <em>etc.</em></p>
<p>The approach taken for multivariate composite models, is that the structures are composed as seen previously into a single one and the resulting state vector is then &quot;collapsed&quot; into a vector on natural parameters, <span class="math inline">\(\eta_t\)</span> which are then used to sample the individual observation components.</p>
<p><span class="math display">\[\theta_t = \lbrace\underbrace{\theta_{1}, \theta_{2}, \theta_{3}}_{\eta_1}, \underbrace{\theta_{4}, \theta_{5}, \theta_{6}}_{\eta_2}\rbrace \\
y = f(\eta_t) \\
= \lbrace f_1(\eta_1), f_2(\eta_2)\rbrace
\]</span></p>
<p>The model composition can be expressed by grouping the different structures and observations under a <code>compose</code> key:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">compose</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">          </span><span style="color:#998;font-style:italic"># component 1</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.5</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>continuous<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.5</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">          </span><span style="color:#998;font-style:italic"># component 2</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">5.0</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">3.7</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>continuous<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">1.5</span><span style="color:#bbb">
</span></pre><h3 id="examples">Examples</h3>
<p>We will look at two separate examples, one that creates a stream of simulated stock prices and one that generates a fake HTTP log.<br />
We assume we want to simulate a stream of per-day stock prices for 3 different companies, each with different characteristics. In this case, we will model the following:</p>
<ul>
<li>Company A's stocks start at quite a high value ($700) and are quite stable throughout time</li>
<li>Company B's stocks start slightly lower than A ($500) and are quite stable in the long run, but show heavy fluctuation from day to day</li>
<li>Company C's stocks start at $600 are very unpredictable</li>
</ul>
<p>Since we will be using per-day data we won't be streaming this in realtime! We can map each daily observation to a second in our stream so we will specify a <code>period=1</code>. All stocks will exhibit a small monthly effect (<code>period=30</code>), which will be indicated by a <code>noise=0.01</code> and a yearly effect (<code>period=365</code>) with a <code>noise=2.5</code>.</p>
<p>The resulting configuration will be:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">compose</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># company A</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">700</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.01</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># low structural variance</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">30</span><span style="color:#bbb">   </span><span style="color:#998;font-style:italic"># monthly seasonality</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.1</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">365</span>.<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># yearly seasonality</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">1.7</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>continuous<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.05</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># low observational variance</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># company B</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">500</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.01</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># low structural variance</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">30</span><span style="color:#bbb">   </span><span style="color:#998;font-style:italic"># monthly seasonality</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.7</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">365</span>.<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># yearly seasonality</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">3.7</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>continuous<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">3.00</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># higher observational variance</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># company C</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">600</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">3.0</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># higher structural variance</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">30</span><span style="color:#bbb">   </span><span style="color:#998;font-style:italic"># monthly seasonality</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.1</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">365</span>.<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># yearly seasonality</span><span style="color:#bbb">
</span><span style="color:#bbb">			</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.25</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>continuous<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">4.0</span><span style="color:#bbb">  </span><span style="color:#998;font-style:italic"># higher observational variance</span><span style="color:#bbb">
</span></pre><p>A realisation of this stream looks like the figure below.</p>
<p><img src="./images/ssm/mv_continous.png" alt="" /></p>
<p>To generate the fake HTTP log we will make the following assumptions:</p>
<ul>
<li>We will have a request type (<code>GET</code>, <code>POST</code>, <code>PUT</code>) which will vary following a random walk</li>
<li>A set of visited pages which, for illustration purposes, will be limited to (<code>/site/page.htm</code>, <code>/site/index.htm</code> and <code>/internal/example.htm</code>). We also want that the URLs visited follow a seasonal pattern.</li>
<li>An IP address in the IPv4 format (<em>i.e.</em> <code>0-255.0-255.0-255.0-255</code>)</li>
</ul>
<p>It is clear that for all variables the appropriate observational model is the categorical one. For the request type and the visited page we can pass directly the category name in the configuration file and for the IP we simply need four categorical observations with <span class="math inline">\(r=255\)</span>.</p>
<p>If the underlying structure is the same, a useful shortcut to specify several observation component is the <code>replicate</code> key. In this particular example to generate four <code>0-255</code> numbers with an underlying mean as the structure, we simple use:</p>
<pre style="background-color:#fff">- <span style="color:#000;font-weight:bold">replicate</span>:<span style="color:#bbb"> </span><span style="color:#099">4</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">2.1</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>categorical<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">categories</span>:<span style="color:#bbb"> </span><span style="color:#099">255</span><span style="color:#bbb">
</span></pre><p>The full configuration for the HTTP log simulation could then be something like this:</p>
<pre style="background-color:#fff"><span style="color:#000;font-weight:bold">compose</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.01</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>categorical<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">values</span>:<span style="color:#bbb"> </span>GET,POST,PUT<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.01</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>season<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">1.0</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">period</span>:<span style="color:#bbb"> </span><span style="color:#099">15</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">0.2</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>categorical<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">values</span>:<span style="color:#bbb"> </span>/site/page.htm,/site/index.htm,/internal/example.htm<span style="color:#bbb">
</span><span style="color:#bbb">	</span>- <span style="color:#000;font-weight:bold">replicate</span>:<span style="color:#bbb"> </span><span style="color:#099">4</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">structure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">		</span>- <span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>mean<span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">start</span>:<span style="color:#bbb"> </span><span style="color:#099">0.0</span><span style="color:#bbb">
</span><span style="color:#bbb">		</span><span style="color:#000;font-weight:bold">noise</span>:<span style="color:#bbb"> </span><span style="color:#099">2.1</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">observations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>categorical<span style="color:#bbb">
</span><span style="color:#bbb">	</span><span style="color:#000;font-weight:bold">categories</span>:<span style="color:#bbb"> </span><span style="color:#099">255</span><span style="color:#bbb">
</span></pre><pre style="background-color:#fff">[&#34;PUT&#34;, &#34;/internal/example.htm&#34;, 171, 158, 59, 89]
[&#34;GET&#34;, &#34;/internal/example.htm&#34;, 171, 253, 71, 146]
[&#34;PUT&#34;, &#34;/internal/example.htm&#34;, 224, 252, 9, 156]
[&#34;POST&#34;, &#34;/site/index.htm&#34;, 143, 253, 6, 126]
[&#34;POST&#34;, &#34;/site/page.htm&#34;, 238, 254, 2, 48]
[&#34;GET&#34;, &#34;/site/page.htm&#34;, 228, 252, 52, 126]
[&#34;POST&#34;, &#34;/internal/example.htm&#34;, 229, 234, 103, 233]
[&#34;GET&#34;, &#34;/internal/example.htm&#34;, 185, 221, 109, 195]
...
</pre><h2 id="setting-up-the-generator">Setting up the generator</h2>
<p>As I have mentioned in the beginning of this post, we want to fit the data simulation solution into a cloud computing workflow. To illustrate this we will use the <a href="https://www.openshift.com/">OpenShift</a> platform which allows for the deployment of containerised applications. A typical setup for a streaming data processing application would be as illustrated in the figure below. We have several sources connected to a message broker, such as Apache Kafka in this case. Data might be partitioned into &quot;topics&quot; which are then consumed by different applications, each performing data processing, either independently or in a distributed manner.</p>
<p><img src="./images/ssm/kafka.png" alt="" /></p>
<p>An advantage of <code>timeseries-mock</code> would then be to replace the &quot;real&quot; data sources with a highly configurable simulator either for the prototyping or initial testing phase. If we consider our previous example of the &quot;fake&quot; HTTP log generation, an application for Web log analytics could be prototyped and tested with simulated log data very quickly, without being blocked by the lack of suitable real data.<br />
Since the data is consumed by proxy via the message broker's topics, we could later on replace the simulator with real data sources seamlessly without an impact on any of the applications.<br />
To setup the generator (and assuming Kafka and your consumer application are already running on OpenShift) we only need to perform two steps:</p>
<ul>
<li>Write the data specifications in a YAML configuration</li>
<li>Use the <code>s2i</code> to deploy the simulator</li>
</ul>
<p>The <code>s2i</code> functionality of OpenShift <a href="https://github.com/openshift/source-to-image">allows to create</a> deployment ready images by simply pointing to a source code location. In this case we could simply write:</p>
<pre style="background-color:#fff">oc new-app centos/python-36-centos7~https://github.com/ruivieira/timeseries-mock <span style="color:#d14">\
</span><span style="color:#d14"></span>-e <span style="color:#008080">KAFKA_BROKERS</span><span style="color:#000;font-weight:bold">=</span>kafka:9092 <span style="color:#d14">\
</span><span style="color:#d14"></span>-e <span style="color:#008080">KAFKA_TOPIC</span><span style="color:#000;font-weight:bold">=</span>example <span style="color:#d14">\
</span><span style="color:#d14"></span>-e <span style="color:#008080">CONF</span><span style="color:#000;font-weight:bold">=</span>examples/mean_continuous.yml <span style="color:#d14">\
</span><span style="color:#d14"></span>--name<span style="color:#000;font-weight:bold">=</span>emitter
</pre><p>In this case, we would deploy a simulator generating data according to the specifications in <code>mean_continuous.yml</code>. This data will be sent to the topic <code>example</code> of a Kafka broker running on port <code>9092</code>.</p>
<p><img src="./images/ssm/kafka_ssm.png" alt="" /></p>
<p>The stream will be ready to consume and message payload will a stream of serialised JSON strings. In the case of the simulated HTTP log this would be:</p>
<pre style="background-color:#fff">{
<span style="color:#a61717;background-color:#e3d2d2">name:</span> <span style="color:#000080">&#34;HTTP log&#34;</span>
<span style="color:#a61717;background-color:#e3d2d2">values</span>: [<span style="color:#d14">&#34;GET&#34;</span>, <span style="color:#d14">&#34;/internal/example.htm&#34;</span>, <span style="color:#099">185</span>, <span style="color:#099">221</span>, <span style="color:#099">109</span>, <span style="color:#099">195</span>]
}
</pre><ul>
<li><code>name</code> - the name given to this stream in the configuration file</li>
<li><code>values</code> - a single observation for this stream</li>
</ul>
<p>After consuming the data it is straight-forward to do any post-processing if needed. For instance, the <code>values</code> above could be easily transformed into a standard Apache Web server log line.</p>
<p>I hope you found this tool useful, simple to use and configure. Some future work includes adding more observations distributions beyond the exponential family and the ability to directly add transformation rules to the generated observations.<br />
If you have any suggestions, use cases (or found an issue!), please let me know in the <a href="https://github.com/ruivieira/timeseries-mock">repository</a>.</p>
<p>If you have any comments please let me know on <a href="https://mastodon.social/@ruivieira">Mastodon</a> (or <a href="https://twitter.com/ruimvieira">Twitter</a>).</p>
<p>Happy coding!</p>

    <div class="footer">
        <span class="cc-symbol">&#127341;</span> 2020 CC BY Rui Vieira
    </div>
</div>

</body>
</html>