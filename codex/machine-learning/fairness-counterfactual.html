
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counterfactual fairness &#8212; Machine Learning</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  
  
  

    
      
  
  

    
    <link rel="stylesheet" href="_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css">
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css">
    
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css">
    
    <link rel="stylesheet" type="text/css" href="_static/bootstrap.css">
    <link rel="stylesheet" type="text/css" href="_static/trac.css">
    <link rel="stylesheet" type="text/css" href="_static/book.css">
    <link rel="stylesheet" type="text/css" href="_static/icomoon.css">
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css">
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css">
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    
    
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    
    
    
    

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  <link rel="preload" as="font" type="font/woff2" crossorigin="" href="/fonts/JuliaMono-Regular.woff2"><link rel="preload" as="font" type="font/woff" crossorigin="" href="_static/icomoon.woff"><link rel="stylesheet" href="_static/icomoon.css"></head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/rat.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Machine Learning</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off">
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Data
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="synthetic-data.html">
   Generating synthetic data
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Processing
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="data-processing.html">
   Data processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sklearn-pipelines.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   Pipelines
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Supervised learning
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="random-forests.html">
   Random forests
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Metrics
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="metrics-distance.html">
   Distance metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="metrics-error.html">
   Error metrics
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Explainability
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="xai-counterfactuals.html">
   Counterfactuals
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Fairness
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="fairness-introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="fairness-demographic_parity.html">
   Demographic parity
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Counterfactual fairness
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="tooltip" data-placement="left" data-target=".site-navigation" aria-controls="site-navigation" aria-expanded="true" aria-label="Toggle navigation" title="Toggle navigation">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode" title="Fullscreen mode"><i class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->



    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-processing">
     Pre-processing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#protected-attributes">
     Protected attributes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-and-testing-subsets">
     Training and testing subsets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unfair-model">
   Unfair model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#full-model">
     Full model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fairness-through-unawareness-ftu">
   Fairness through unawareness (FTU)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#latent-variable-model">
   Latent variable model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#additive-error-model">
   Additive error model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison">
   Comparison
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="counterfactual-fairness">
<h1>Counterfactual fairness<a class="headerlink" href="#counterfactual-fairness" title="Permalink to this headline">¶</a></h1>
<div class="section" id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>To evaluate <em>counterfactual fairness</em> we will be using the “law school” dataset <a class="bibtex reference internal" href="xai-counterfactuals.html#mcintyre2018law" id="id1">[MS18]</a>.</p>
<p>The Law School Admission Council conducted a survey across 163 law schools in the United States.
It contains information on 21,790 law students such as their entrance exam scores (<code class="docutils literal notranslate"><span class="pre">LSAT</span></code>), their
grade-point average (<code class="docutils literal notranslate"><span class="pre">GPA</span></code>) collected prior to law school, and their first year average grade (<code class="docutils literal notranslate"><span class="pre">FYA</span></code>).
Given this data, a school may wish to predict if an applicant will have a high <code class="docutils literal notranslate"><span class="pre">FYA</span></code>. The school would
also like to make sure these predictions are not biased by an individual’s race and sex.
However, the <code class="docutils literal notranslate"><span class="pre">LSAT</span></code>, <code class="docutils literal notranslate"><span class="pre">GPA</span></code>, and <code class="docutils literal notranslate"><span class="pre">FYA</span></code> scores, may be biased due to social factors.</p>
<p>We start by importing the data into a Pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/law_data.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>race</th>
      <th>sex</th>
      <th>LSAT</th>
      <th>UGPA</th>
      <th>region_first</th>
      <th>ZFYA</th>
      <th>sander_index</th>
      <th>first_pf</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>White</td>
      <td>1</td>
      <td>39.0</td>
      <td>3.1</td>
      <td>GL</td>
      <td>-0.98</td>
      <td>0.782738</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>White</td>
      <td>1</td>
      <td>36.0</td>
      <td>3.0</td>
      <td>GL</td>
      <td>0.09</td>
      <td>0.735714</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>White</td>
      <td>2</td>
      <td>30.0</td>
      <td>3.1</td>
      <td>MS</td>
      <td>-0.35</td>
      <td>0.670238</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Hispanic</td>
      <td>2</td>
      <td>39.0</td>
      <td>2.2</td>
      <td>NE</td>
      <td>0.58</td>
      <td>0.697024</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>White</td>
      <td>1</td>
      <td>37.0</td>
      <td>3.4</td>
      <td>GL</td>
      <td>-1.26</td>
      <td>0.786310</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="pre-processing">
<h3>Pre-processing<a class="headerlink" href="#pre-processing" title="Permalink to this headline">¶</a></h3>
<p>We now pre-process the data. We start by creating categorical “dummy” variables according to the <code class="docutils literal notranslate"><span class="pre">race</span></code> variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">prefix_sep</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sex</th>
      <th>LSAT</th>
      <th>UGPA</th>
      <th>region_first</th>
      <th>ZFYA</th>
      <th>sander_index</th>
      <th>first_pf</th>
      <th>Amerindian</th>
      <th>Asian</th>
      <th>Black</th>
      <th>Hispanic</th>
      <th>Mexican</th>
      <th>Other</th>
      <th>Puertorican</th>
      <th>White</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>39.0</td>
      <td>3.1</td>
      <td>GL</td>
      <td>-0.98</td>
      <td>0.782738</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>36.0</td>
      <td>3.0</td>
      <td>GL</td>
      <td>0.09</td>
      <td>0.735714</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>30.0</td>
      <td>3.1</td>
      <td>MS</td>
      <td>-0.35</td>
      <td>0.670238</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2</td>
      <td>39.0</td>
      <td>2.2</td>
      <td>NE</td>
      <td>0.58</td>
      <td>0.697024</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>37.0</td>
      <td>3.4</td>
      <td>GL</td>
      <td>-1.26</td>
      <td>0.786310</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We also want to expand the <code class="docutils literal notranslate"><span class="pre">sex</span></code> variable into <code class="docutils literal notranslate"><span class="pre">male</span></code>/<code class="docutils literal notranslate"><span class="pre">female</span></code> categorical variables and remove the original.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;male&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;female&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSAT</th>
      <th>UGPA</th>
      <th>region_first</th>
      <th>ZFYA</th>
      <th>sander_index</th>
      <th>first_pf</th>
      <th>Amerindian</th>
      <th>Asian</th>
      <th>Black</th>
      <th>Hispanic</th>
      <th>Mexican</th>
      <th>Other</th>
      <th>Puertorican</th>
      <th>White</th>
      <th>male</th>
      <th>female</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>39.0</td>
      <td>3.1</td>
      <td>GL</td>
      <td>-0.98</td>
      <td>0.782738</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>36.0</td>
      <td>3.0</td>
      <td>GL</td>
      <td>0.09</td>
      <td>0.735714</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30.0</td>
      <td>3.1</td>
      <td>MS</td>
      <td>-0.35</td>
      <td>0.670238</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>39.0</td>
      <td>2.2</td>
      <td>NE</td>
      <td>0.58</td>
      <td>0.697024</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>37.0</td>
      <td>3.4</td>
      <td>GL</td>
      <td>-1.26</td>
      <td>0.786310</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We will also convert the entrance exam scores (<code class="docutils literal notranslate"><span class="pre">LSAT</span></code>) to a discrete variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>LSAT</th>
      <th>UGPA</th>
      <th>region_first</th>
      <th>ZFYA</th>
      <th>sander_index</th>
      <th>first_pf</th>
      <th>Amerindian</th>
      <th>Asian</th>
      <th>Black</th>
      <th>Hispanic</th>
      <th>Mexican</th>
      <th>Other</th>
      <th>Puertorican</th>
      <th>White</th>
      <th>male</th>
      <th>female</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>39</td>
      <td>3.1</td>
      <td>GL</td>
      <td>-0.98</td>
      <td>0.782738</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>36</td>
      <td>3.0</td>
      <td>GL</td>
      <td>0.09</td>
      <td>0.735714</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>30</td>
      <td>3.1</td>
      <td>MS</td>
      <td>-0.35</td>
      <td>0.670238</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>39</td>
      <td>2.2</td>
      <td>NE</td>
      <td>0.58</td>
      <td>0.697024</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>37</td>
      <td>3.4</td>
      <td>GL</td>
      <td>-1.26</td>
      <td>0.786310</td>
      <td>1.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="protected-attributes">
<h3>Protected attributes<a class="headerlink" href="#protected-attributes" title="Permalink to this headline">¶</a></h3>
<p><em>Counterfactual fairness</em> enforces that a distribution over possible predictions for an individual should
remain unchanged in a world where an individual’s protected attributes <span class="math notranslate nohighlight">\(A\)</span> had been different in a causal sense</p>
<p>Let’s start by defining the <em>protected attributes</em>. Obvious candidates are the different categorical variables for ethnicity (<code class="docutils literal notranslate"><span class="pre">Asian</span></code>, <code class="docutils literal notranslate"><span class="pre">White</span></code>, <code class="docutils literal notranslate"><span class="pre">Black</span></code>, <em>etc</em>) and gender (<code class="docutils literal notranslate"><span class="pre">male</span></code>, <code class="docutils literal notranslate"><span class="pre">female</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Amerindian&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Asian&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Black&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Hispanic&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mexican&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Puertorican&quot;</span><span class="p">,</span>
    <span class="s2">&quot;White&quot;</span><span class="p">,</span>
    <span class="s2">&quot;male&quot;</span><span class="p">,</span>
    <span class="s2">&quot;female&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="training-and-testing-subsets">
<h3>Training and testing subsets<a class="headerlink" href="#training-and-testing-subsets" title="Permalink to this headline">¶</a></h3>
<p>We will now divide the dataset into training and testing subsets.
We will use the same ratio as in <a class="bibtex reference internal" href="xai-counterfactuals.html#kusner2017" id="id2">[KLRS17]</a>, that is 20%.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">df_train</span><span class="p">,</span> <span class="n">df_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="unfair-model">
<h2>Unfair model<a class="headerlink" href="#unfair-model" title="Permalink to this headline">¶</a></h2>
<p>As detailed in <a class="bibtex reference internal" href="xai-counterfactuals.html#kusner2017" id="id3">[KLRS17]</a>, the concept of counterfactual fairness holds
under three levels of assumptions of increasing strength.</p>
<p>The first of such levels is <strong>Level 1</strong>, where <span class="math notranslate nohighlight">\(\hat{Y}\)</span> is built using only the observable non-descendants of <span class="math notranslate nohighlight">\(A\)</span>.
This only requires <strong>partial</strong> causal ordering and no further causal assumptions, but in many problems there will be few, if any,
observables which are not descendants of protected demographic factors.</p>
<p>For this dataset, since <code class="docutils literal notranslate"><span class="pre">LSAT</span></code>, <code class="docutils literal notranslate"><span class="pre">GPA</span></code>, and <code class="docutils literal notranslate"><span class="pre">FYA</span></code> are all biased by ethnicity and gender, we cannot use any observed
features to construct a Level 1 counterfactually fair predictor as described in Level 1.</p>
<p>Instead (and in order to compare the performance with Level 2 and 3 models) we will build two <em>unfair baselines</em>.</p>
<ul class="simple">
<li><p>A *<em>Full</em> model, which will be trained with the totality of the variables</p></li>
<li><p>An <strong>Unaware</strong> model (FTU), which will be trained will all the variables, except the protected attributes <span class="math notranslate nohighlight">\(A\)</span>.</p></li>
</ul>
<p>Let’s proceed with calculating the <strong>Full</strong> model.</p>
<div class="section" id="full-model">
<h3>Full model<a class="headerlink" href="#full-model" title="Permalink to this headline">¶</a></h3>
<p>As mentioned previously, the full model will be a simple linear regression in order to predict <code class="docutils literal notranslate"><span class="pre">ZFYA</span></code> using all of the variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="n">linreg_unfair</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The inputs will then be the totality of the variabes (protected variables <span class="math notranslate nohighlight">\(A\)</span>, as well as <code class="docutils literal notranslate"><span class="pre">UGPA</span></code> and <code class="docutils literal notranslate"><span class="pre">LSAT</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">df_train</span><span class="p">[</span><span class="n">A</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;UGPA&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 0.   0.   0.  ...  1.   3.1 39. ]
 [ 0.   0.   0.  ...  1.   3.5 36. ]
 [ 0.   0.   0.  ...  1.   3.9 46. ]
 ...
 [ 0.   0.   0.  ...  1.   2.9 33. ]
 [ 0.   0.   0.  ...  0.   2.9 31. ]
 [ 0.   0.   0.  ...  0.   3.6 39. ]]
</pre></div>
</div>
</div>
</div>
<p>As for our target, we are trying to predict <code class="docutils literal notranslate"><span class="pre">ZFYA</span></code> (first year average grade).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">]</span>
<span class="n">y</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10454    0.56
14108    0.60
20624   -0.14
8316     0.20
14250    0.02
18909   -1.47
8949     1.36
1658     0.39
23340    0.10
26884    0.48
Name: ZFYA, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>We fit the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linreg_unfair</span> <span class="o">=</span> <span class="n">linreg_unfair</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And perform some predictions on the test subset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">df_test</span><span class="p">[</span><span class="n">A</span><span class="p">],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;UGPA&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">X_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0. ,  0. ,  0. , ...,  0. ,  3.4, 32. ],
       [ 0. ,  0. ,  0. , ...,  1. ,  3.5, 41. ],
       [ 0. ,  0. ,  0. , ...,  1. ,  3.9, 42. ],
       ...,
       [ 0. ,  0. ,  0. , ...,  0. ,  2.3, 28. ],
       [ 0. ,  0. ,  0. , ...,  0. ,  3.3, 36. ],
       [ 0. ,  0. ,  0. , ...,  0. ,  2.9, 37. ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_unfair</span> <span class="o">=</span> <span class="n">linreg_unfair</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">predictions_unfair</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.08676147,  0.34942627,  0.4609375 , ..., -0.25949097,
        0.19308472,  0.14471436])
</pre></div>
</div>
</div>
</div>
<p>We will also calculate the <em>unfair model</em> score for future use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">score_unfair</span> <span class="o">=</span> <span class="n">linreg_unfair</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">score_unfair</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.12701634112845117
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="n">RMSE_unfair</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">],</span> <span class="n">predictions_unfair</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">RMSE_unfair</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8666709890234552
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="fairness-through-unawareness-ftu">
<h2>Fairness through unawareness (FTU)<a class="headerlink" href="#fairness-through-unawareness-ftu" title="Permalink to this headline">¶</a></h2>
<p>As also mentioned in <a class="bibtex reference internal" href="xai-counterfactuals.html#kusner2017" id="id4">[KLRS17]</a>, the second baseline we will use is an <strong>Unaware</strong> model (FTU), which will be trained will all the variables, except the protected attributes <span class="math notranslate nohighlight">\(A\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linreg_ftu</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We will create the inputs as previously, but without using the protected attributes, <span class="math notranslate nohighlight">\(A\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_ftu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;UGPA&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">X_ftu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 3.1, 39. ],
       [ 3.5, 36. ],
       [ 3.9, 46. ],
       ...,
       [ 2.9, 33. ],
       [ 2.9, 31. ],
       [ 3.6, 39. ]])
</pre></div>
</div>
</div>
</div>
<p>And we fit the model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linreg_ftu</span> <span class="o">=</span> <span class="n">linreg_ftu</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_ftu</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Again, let’s perform some predictions on the test subset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_ftu_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;UGPA&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">X_ftu_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 3.4, 32. ],
       [ 3.5, 41. ],
       [ 3.9, 42. ],
       ...,
       [ 2.3, 28. ],
       [ 3.3, 36. ],
       [ 2.9, 37. ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_ftu</span> <span class="o">=</span> <span class="n">linreg_ftu</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_ftu_test</span><span class="p">)</span>
<span class="n">predictions_ftu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.06909331,  0.35516229,  0.50304555, ..., -0.53109868,
        0.08204563,  0.0226846 ])
</pre></div>
</div>
</div>
</div>
<p>As previously, let’s calculate this model’s score.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ftu_score</span> <span class="o">=</span> <span class="n">linreg_ftu</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_ftu_test</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ftu_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0917442226187073
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RMSE_ftu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">],</span> <span class="n">predictions_ftu</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">RMSE_ftu</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8840061503773576
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="latent-variable-model">
<h2>Latent variable model<a class="headerlink" href="#latent-variable-model" title="Permalink to this headline">¶</a></h2>
<p>Still according to <a class="bibtex reference internal" href="xai-counterfactuals.html#kusner2017" id="id5">[KLRS17]</a>, a <strong>Level 2</strong> approach will model latent ‘fair’ variables which are parents of observed variables.</p>
<p>If we consider a predictor parameterised by <span class="math notranslate nohighlight">\(\theta\)</span>, such as:</p>
<div class="math notranslate nohighlight">
\[
\hat{Y} \equiv g_\theta (U, X_{\nsucc A})
\]</div>
<p>with <span class="math notranslate nohighlight">\(X_{\nsucc A} \subseteq X\)</span> are non-descendants of <span class="math notranslate nohighlight">\(A\)</span>.
Assuming a loss function <span class="math notranslate nohighlight">\(l(\cdot,\cdot)\)</span> and training data <span class="math notranslate nohighlight">\(\mathcal{D}\equiv\{(A^{(i), X^{(i)}, Y^{(i)}})\}\)</span>, for <span class="math notranslate nohighlight">\(i=1,2\dots,n\)</span>, the empirical loss is defined as</p>
<div class="math notranslate nohighlight">
\[
L(\theta)\equiv \sum_{i=1}^n \mathbb{E}[l(y^{(i)},g_\theta(U^{(i)}, x^{(i)}_{\nsucc A}))]/n
\]</div>
<p>which has to be minimised in order to <span class="math notranslate nohighlight">\(\theta\)</span>. Each <span class="math notranslate nohighlight">\(n\)</span> expectation is with respect to random variable <span class="math notranslate nohighlight">\(U^{(i)}\)</span> such that</p>
<div class="math notranslate nohighlight">
\[
U^{(i)}\sim P_{\mathcal{M}}(U|x^{(i)}, a^{(i)})
\]</div>
<p>where <span class="math notranslate nohighlight">\(P_{\mathcal{M}}(U|x,a)\)</span> is the conditional distribution of the background variables as given by a causal model M that is available by assumption.</p>
<p>If this expectation cannot be calculated analytically, Markov chain Monte Carlo (MCMC) can be used to approximate it as in the following algorithm.</p>
<p>We will follow the model specified in the original paper, where the latent variable considered is <span class="math notranslate nohighlight">\(K\)</span>, which represents a student’s <strong>knowledge</strong>.
<span class="math notranslate nohighlight">\(K\)</span> will affect <code class="docutils literal notranslate"><span class="pre">GPA</span></code>, <code class="docutils literal notranslate"><span class="pre">LSAT</span></code> and the outcome, <code class="docutils literal notranslate"><span class="pre">FYA</span></code>.
The model can be defined by:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
GPA \sim \mathcal{N}(GPA_0 + w_{GPA}^KK + w_{GPA}^RR + w_{GPA}^SS, \sigma_{GPA}) \\
LSAT \sim \text{Po}(\exp(LSAT_0 + w_{LSAT}^KK + w_{LSAT}^RR + w_L^SS)) \\
FYA \sim \mathcal{N}(w_{FYA}^KK + w_{FYA}^RR + w_{FYA}^SS, 1) \\
K \sim \mathcal{N}(0,1)
\end{split}\]</div>
<p>The priors used will be:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
GPA_0 \sim \mathcal{N}(0, 1) \\
LSAT_0 \sim \mathcal{N}(0, 1) \\
GPA_0 \sim \mathcal{N}(0, 1) \\
\end{split}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>

<span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">MCMC</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">A</span><span class="p">])</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">model</span><span class="p">:</span>
        <span class="c1"># Priors</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
        <span class="n">gpa0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;gpa0&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lsat0</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;lsat0&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">w_k_gpa</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;w_k_gpa&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">w_k_lsat</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;w_k_lsat&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">w_k_zfya</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;w_k_zfya&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">w_a_gpa</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;w_a_gpa&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
        <span class="n">w_a_lsat</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;w_a_lsat&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>
        <span class="n">w_a_zfya</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;w_a_zfya&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="n">K</span><span class="p">)</span>

        <span class="n">sigma_gpa_2</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">InverseGamma</span><span class="p">(</span><span class="s2">&quot;sigma_gpa_2&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">gpa0</span> <span class="o">+</span> <span class="p">(</span><span class="n">w_k_gpa</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">w_a_gpa</span><span class="p">)</span>

        <span class="c1"># Observed data</span>
        <span class="n">gpa</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;gpa&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_gpa_2</span><span class="p">),</span>
            <span class="n">observed</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;UGPA&quot;</span><span class="p">]),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">lsat</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span>
            <span class="s2">&quot;lsat&quot;</span><span class="p">,</span>
            <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lsat0</span> <span class="o">+</span> <span class="n">w_k_lsat</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">w_a_lsat</span><span class="p">)),</span>
            <span class="n">observed</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LSAT&quot;</span><span class="p">]),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">zfya</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
            <span class="s2">&quot;zfya&quot;</span><span class="p">,</span>
            <span class="n">mu</span><span class="o">=</span><span class="n">w_k_zfya</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">w_a_zfya</span><span class="p">),</span>
            <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">observed</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">]),</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Metropolis</span><span class="p">()</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">trace</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_estimates</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;Metropolis: [sigma_gpa_2]
&gt;Metropolis: [w_a_zfya]
&gt;Metropolis: [w_a_lsat]
&gt;Metropolis: [w_a_gpa]
&gt;Metropolis: [w_k_zfya]
&gt;Metropolis: [w_k_lsat]
&gt;Metropolis: [w_k_gpa]
&gt;Metropolis: [lsat0]
&gt;Metropolis: [gpa0]
&gt;Metropolis: [k]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
  100.00% [8000/8000 01:22<00:00 0="" 4="" Sampling="" chains,="" divergences]="" <=""></00:00>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 94 seconds.
The rhat statistic is larger than 1.4 for some parameters. The sampler did not converge.
The estimated number of effective samples is smaller than 200 for some parameters.
</pre></div>
</div>
</div>
</div>
<p>Let’s plot a single trace for <span class="math notranslate nohighlight">\(k^{(i)}\)</span>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">plotutils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Thin the samples before plotting</span>
<span class="n">k_trace</span> <span class="o">=</span> <span class="n">train_estimates</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">::</span><span class="mi">100</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">k_trace</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">k_trace</span><span class="p">)),</span> <span class="n">k_trace</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fairness-counterfactual_52_0.png" src="_images/fairness-counterfactual_52_0.png">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_estimates</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">train_k</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 0.20658037],
       [-0.04806536],
       [-0.01335303],
       ...,
       [ 0.09076849],
       [ 0.11204019],
       [ 0.02730821]])
</pre></div>
</div>
</div>
</div>
<p>We can now estimate <span class="math notranslate nohighlight">\(k\)</span> using the test data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_map_estimates</span> <span class="o">=</span> <span class="n">MCMC</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiprocess sampling (4 chains in 4 jobs)
CompoundStep
&gt;Metropolis: [sigma_gpa_2]
&gt;Metropolis: [w_a_zfya]
&gt;Metropolis: [w_a_lsat]
&gt;Metropolis: [w_a_gpa]
&gt;Metropolis: [w_k_zfya]
&gt;Metropolis: [w_k_lsat]
&gt;Metropolis: [w_k_gpa]
&gt;Metropolis: [lsat0]
&gt;Metropolis: [gpa0]
&gt;Metropolis: [k]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value="8000" class="" max="8000" style="width:300px; height:20px; vertical-align: middle;"></progress>
  100.00% [8000/8000 00:33<00:00 0="" 4="" Sampling="" chains,="" divergences]="" <=""></00:00>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 48 seconds.
The rhat statistic is larger than 1.4 for some parameters. The sampler did not converge.
The estimated number of effective samples is smaller than 200 for some parameters.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">test_map_estimates</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_k</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.2111925 ],
       [ 0.29696172],
       [-0.16900098],
       ...,
       [-0.01713051],
       [-0.07469816],
       [-0.30665221]])
</pre></div>
</div>
</div>
</div>
<p>We now build the Level 2 predictor, using <span class="math notranslate nohighlight">\(k\)</span> as the input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linreg_latent</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linreg_latent</span> <span class="o">=</span> <span class="n">linreg_latent</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_k</span><span class="p">,</span> <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_latent</span> <span class="o">=</span> <span class="n">linreg_latent</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_k</span><span class="p">)</span>
<span class="n">predictions_latent</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.01980993,  0.25255695,  0.00280441, ...,  0.08420585,
        0.05335002, -0.07097563])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">latent_score</span> <span class="o">=</span> <span class="n">linreg_latent</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">test_k</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">latent_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0067887409029733226
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RMSE_latent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">],</span> <span class="n">predictions_latent</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">RMSE_latent</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9244257176167182
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="additive-error-model">
<h2>Additive error model<a class="headerlink" href="#additive-error-model" title="Permalink to this headline">¶</a></h2>
<p>Finally, in <strong>Level 3</strong>, we model <code class="docutils literal notranslate"><span class="pre">GPA</span></code>, <code class="docutils literal notranslate"><span class="pre">LSAT</span></code>, and <code class="docutils literal notranslate"><span class="pre">FYA</span></code> as continuous variables with additive error terms
independent of race and sex<a class="footnote-reference brackets" href="#id8" id="id6">2</a>.</p>
<p>This corresponds to</p>
<div class="math notranslate nohighlight">
\[\begin{split}
GPA = b_G + w^R_{GPA}R + w^S_{GPA}S + \epsilon_{GPA}, \epsilon_{GPA} \sim p(\epsilon_{GPA}) \\
LSAT = b_L + w^R_{LSAT}R + w^S_{LSAT}S + \epsilon_{LSAT}, \epsilon_{LSAT} \sim p(\epsilon_{LSAT}) \\
FYA = b_{FYA} + w^R_{FYA}R + w^S_{FYA}S + \epsilon_{FYA} , \epsilon_{FYA} \sim p(\epsilon_{FYA})
\end{split}\]</div>
<p>We estimate the error terms <span class="math notranslate nohighlight">\(\epsilon_{GPA}, \epsilon_{LSAT}\)</span> by first fitting two models that each use race and sex to individually
predict <code class="docutils literal notranslate"><span class="pre">GPA</span></code> and <code class="docutils literal notranslate"><span class="pre">LSAT</span></code>. We then compute the residuals of each model (<em>e.g.</em>, <span class="math notranslate nohighlight">\(\epsilon_{GPA} =GPA−\hat{Y}_{GPA}(R, S)\)</span>).
We use these residual estimates of <span class="math notranslate nohighlight">\(\epsilon_{GPA}, \epsilon_{LSAT}\)</span> to predict <span class="math notranslate nohighlight">\(FYA\)</span>. In <a class="bibtex reference internal" href="xai-counterfactuals.html#kusner2017" id="id7">[KLRS17]</a> this is called <em>Fair Add</em>.</p>
<p>Since the process is similar for the individual predictions for <code class="docutils literal notranslate"><span class="pre">GPA</span></code> and <code class="docutils literal notranslate"><span class="pre">LSAT</span></code>, we will write a method to avoid repetion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_epsilon</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">protected_attr</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">protected_attr</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>

    <span class="n">linreg</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
    <span class="n">linreg</span> <span class="o">=</span> <span class="n">linreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">linreg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">-</span> <span class="n">predictions</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s apply it to each variable, individually.
First we calculate <span class="math notranslate nohighlight">\(\epsilon_{GPA}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epsilons_gpa</span> <span class="o">=</span> <span class="n">calculate_epsilon</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;UGPA&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="n">epsilons_gpa</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0       -0.241797
1       -0.341797
2       -0.100195
5       -0.873242
6        0.058203
           ...   
27472    0.799805
27473    0.358203
27474    0.658203
27475   -0.300195
27476   -0.100195
Name: UGPA, Length: 21791, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Next, we calculate <span class="math notranslate nohighlight">\(\epsilon_{LSAT}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epsilons_LSAT</span> <span class="o">=</span> <span class="n">calculate_epsilon</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;LSAT&quot;</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="n">epsilons_LSAT</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0        1.789062
1       -1.210938
2       -7.689453
5        5.054688
6       -0.210938
           ...   
27472   -4.689453
27473    0.789062
27474   -1.210938
27475   -6.689453
27476   -9.689453
Name: LSAT, Length: 21791, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Let’s visualise the <span class="math notranslate nohighlight">\(\epsilon\)</span> distribution quickly:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">plotutils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">epsilons_gpa</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\epsilon_</span><span class="si">{GPA}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\epsilon_</span><span class="si">{GPA}</span><span class="s2">$&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">epsilons_LSAT</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;$\epsilon_</span><span class="si">{LSAT}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\epsilon_</span><span class="si">{LSAT}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fairness-counterfactual_73_0.png" src="_images/fairness-counterfactual_73_0.png">
</div>
</div>
<p>We finally use the calculated <span class="math notranslate nohighlight">\(\epsilon\)</span> to train a model in order to predict <code class="docutils literal notranslate"><span class="pre">FYA</span></code>.
We start by getting the subset of the <span class="math notranslate nohighlight">\(\epsilon\)</span> which match the training indices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epsilons_gpa</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epsilons_LSAT</span><span class="p">[</span><span class="n">df_train</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">X</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[-0.24179687,  1.7890625 ],
       [ 0.15820312, -1.2109375 ],
       [ 0.55820312,  8.7890625 ],
       ...,
       [-0.44179688, -4.2109375 ],
       [-0.25087891, -4.7265625 ],
       [ 0.39980469,  1.31054688]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linreg_fair_add</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>

<span class="n">linreg_fair_add</span> <span class="o">=</span> <span class="n">linreg_fair_add</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">df_train</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now use this model to calculate the predictions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epsilons_gpa</span><span class="p">[</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">epsilons_LSAT</span><span class="p">[</span><span class="n">df_test</span><span class="o">.</span><span class="n">index</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">predictions_fair_add</span> <span class="o">=</span> <span class="n">linreg_fair_add</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">predictions_fair_add</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.04394693,  0.24454891,  0.35558793, ..., -0.38844376,
        0.06136776,  0.01295201])
</pre></div>
</div>
</div>
</div>
<p>And as previously, we calculate the model’s score:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fair_add_score</span> <span class="o">=</span> <span class="n">linreg_fair_add</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fair_add_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.04475841449183948
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RMSE_fair_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s2">&quot;ZFYA&quot;</span><span class="p">],</span> <span class="n">predictions_fair_add</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">RMSE_fair_add</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9065835039365202
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="comparison">
<h2>Comparison<a class="headerlink" href="#comparison" title="Permalink to this headline">¶</a></h2>
<p>The score so far are:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unfair score:</span><span class="se">\t</span><span class="si">{</span><span class="n">score_unfair</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FTU score:</span><span class="se">\t</span><span class="si">{</span><span class="n">ftu_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L2 score:</span><span class="se">\t</span><span class="si">{</span><span class="n">latent_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fair add score:</span><span class="se">\t</span><span class="si">{</span><span class="n">fair_add_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unfair score:	0.12701634112845117
FTU score:	0.0917442226187073
L2 score:	0.0067887409029733226
Fair add score:	0.04475841449183948
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unfair RMSE:</span><span class="se">\t</span><span class="si">{</span><span class="n">RMSE_unfair</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FTU RMSE:</span><span class="se">\t</span><span class="si">{</span><span class="n">RMSE_ftu</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L2 RMSE:</span><span class="se">\t</span><span class="si">{</span><span class="n">RMSE_latent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fair add RMSE:</span><span class="se">\t</span><span class="si">{</span><span class="n">RMSE_fair_add</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unfair RMSE:	0.8666709890234552
FTU RMSE:	0.8840061503773576
L2 RMSE:	0.9244257176167182
Fair add RMSE:	0.9065835039365202
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p id="bibtex-bibliography-fairness-counterfactual-0"><dl class="citation">
<dt class="bibtex label" id="kusner2017"><span class="brackets">KLRS17</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id3">2</a>,<a href="#id4">3</a>,<a href="#id5">4</a>,<a href="#id7">5</a>)</span></dt>
<dd><p>Matt Kusner, Joshua Loftus, Chris Russell, and Ricardo Silva. Counterfactual fairness. <em>Advances in Neural Information Processing Systems</em>, 2017-Decem(Nips):4067–4077, 2017. <a class="reference external" href="https://arxiv.org/abs/1703.06856">arXiv:1703.06856</a>.</p>
</dd>
<dt class="bibtex label" id="mcintyre2018law"><span class="brackets"><a class="fn-backref" href="#id1">MS18</a></span></dt>
<dd><p>Frank McIntyre and Michael Simkovic. Are law degrees as valuable to minorities? <em>International Review of Law and Economics</em>, 53:23–37, 2018.</p>
</dd>
</dl>
</p>
<hr class="docutils">
<dl class="footnote brackets">
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id6">2</a></span></dt>
<dd><p>That may in turn be correlated with one-another.</p>
</dd>
</dl>
</div>
</div>

    
    <script>kernelName = 'ml'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class="prev-next-bottom">
        
    <a class="left-prev" id="prev-link" href="fairness-demographic_parity.html" title="previous page">Demographic parity</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Rui Vieira<br>
        
            &copy; Copyright 2020.<br>
      </p>
    </div>
  </footer>
</div></div></main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-10507665-2', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    <!-- End Google Analytics -->
    
  </body>
</html>