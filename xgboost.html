<!DOCTYPE html>
<html lang="en-uk">
<head>
  <script data-goatcounter="https://ruivieira-dev.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  <link rel="preload" href="/lib/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/kbd.css" type="text/css">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> XGBoost | Rui Vieira</title>
  <link rel = 'canonical' href = 'http://ruivieira.dev/xgboost.html'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="XGBoost" />
<meta property="og:description" content="Introduction Example Training XGBoost with the credit-bias dataset.
import pandas as pd data = pd.read_csv(&quot;data/credit-bias-train.zip&quot;) data.head() NewCreditCustomer Amount Interest LoanDuration Education \ 0 False 2125.0 20.97 60 4.0 1 False 3000.0 17.12 60 5.0 2 True 9100.0 13.67 60 4.0 3 True 635.0 42.66 60 2.0 4 False 5000.0 24.52 60 4.0 NrOfDependants EmploymentDurationCurrentEmployer \ 0 0.0 6.0 1 0.0 6.0 2 1.0 3.0 3 0.0 1.0 4 1.0 5.0 IncomeFromPrincipalEmployer IncomeFromPension IncomeFromFamilyAllowance \ 0 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ruivieira.dev/xgboost.html" /><meta property="article:section" content="posts" />

<meta property="article:modified_time" content="2021-12-07T21:49:31+00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="XGBoost"/>
<meta name="twitter:description" content="Introduction Example Training XGBoost with the credit-bias dataset.
import pandas as pd data = pd.read_csv(&quot;data/credit-bias-train.zip&quot;) data.head() NewCreditCustomer Amount Interest LoanDuration Education \ 0 False 2125.0 20.97 60 4.0 1 False 3000.0 17.12 60 5.0 2 True 9100.0 13.67 60 4.0 3 True 635.0 42.66 60 2.0 4 False 5000.0 24.52 60 4.0 NrOfDependants EmploymentDurationCurrentEmployer \ 0 0.0 6.0 1 0.0 6.0 2 1.0 3.0 3 0.0 1.0 4 1.0 5.0 IncomeFromPrincipalEmployer IncomeFromPension IncomeFromFamilyAllowance \ 0 0."/>

  
  
    
  
  
  <link rel="stylesheet" href="http://ruivieira.dev/css/styles.11452b79971f363af7cee81005cd790dc0a7c965142f8adb59e36437063f2d447687b3711ada73b6a88b3b41a41508a42a384d9620740b48cefa0ea9f5e49459.css" integrity="sha512-EUUreZcfNjr3zugQBc15DcCnyWUUL4rbWeNkNwY/LUR2h7NxGtpztqiLO0GkFQikKjhNliB0C0jO&#43;g6p9eSUWQ=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="http://ruivieira.dev/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/map/">All pages</a></li>
         
        <li><a href="/search.html">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li>
          <a class="icon" href="http://ruivieira.dev/workflow.html" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=http%3a%2f%2fruivieira.dev%2fxgboost.html" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&text=XGBoost" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&title=XGBoost" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&is_video=false&description=XGBoost" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=XGBoost&body=Check out this article: http%3a%2f%2fruivieira.dev%2fxgboost.html" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&title=XGBoost" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&title=XGBoost" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&name=XGBoost&description=Introduction%20Example%20Training%20XGBoost%20with%20the%20credit-bias%20dataset.%0aimport%20pandas%20as%20pd%20data%20%3d%20pd.read_csv%28%26quot%3bdata%2fcredit-bias-train.zip%26quot%3b%29%20data.head%28%29%20NewCreditCustomer%20Amount%20Interest%20LoanDuration%20Education%20%5c%200%20False%202125.0%2020.97%2060%204.0%201%20False%203000.0%2017.12%2060%205.0%202%20True%209100.0%2013.67%2060%204.0%203%20True%20635.0%2042.66%2060%202.0%204%20False%205000.0%2024.52%2060%204.0%20NrOfDependants%20EmploymentDurationCurrentEmployer%20%5c%200%200.0%206.0%201%200.0%206.0%202%201.0%203.0%203%200.0%201.0%204%201.0%205.0%20IncomeFromPrincipalEmployer%20IncomeFromPension%20IncomeFromFamilyAllowance%20%5c%200%200." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2fruivieira.dev%2fxgboost.html&t=XGBoost" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    
    <div id="toc">
      <h4>Contents</h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#example">Example</a></li>
    <li><a href="#visualisation">Visualisation</a></li>
    <li><a href="#roc-and-auc">ROC and AUC</a></li>
  </ul>
</nav>
      
      </ul>
    </nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        XGBoost
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          Updated <time datetime="2021-12-07 21:49:31 &#43;0000 GMT" itemprop="datePublished">2021-12-07</time>
          <span class="commit-hash">(186a405)</span>
        </div>
        
        
        
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <h2 id="introduction">Introduction</h2>
<h2 id="example">Example</h2>
<p>Training XGBoost with the credit-bias dataset.</p>
<pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">import pandas as pd

data = pd.read_csv(&quot;data/credit-bias-train.zip&quot;)
data.head()
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">   NewCreditCustomer  Amount  Interest  LoanDuration  Education  \
0              False  2125.0     20.97            60        4.0
1              False  3000.0     17.12            60        5.0
2               True  9100.0     13.67            60        4.0
3               True   635.0     42.66            60        2.0
4              False  5000.0     24.52            60        4.0

   NrOfDependants  EmploymentDurationCurrentEmployer  \
0             0.0                                6.0
1             0.0                                6.0
2             1.0                                3.0
3             0.0                                1.0
4             1.0                                5.0

   IncomeFromPrincipalEmployer  IncomeFromPension  IncomeFromFamilyAllowance  \
0                          0.0              301.0                        0.0
1                        900.0                0.0                        0.0
2                        600.0                0.0                        0.0
3                        745.0                0.0                        0.0
4                       1000.0                0.0                        0.0

   ...  Mortgage  Other  Owner  Owner_with_encumbrance  Tenant  Entrepreneur  \
0  ...         0      0      1                       0       0             0
1  ...         0      0      1                       0       0             1
2  ...         1      0      0                       0       0             1
3  ...         0      0      0                       0       1             0
4  ...         0      0      0                       0       0             0

   Fully  Partially  Retiree  Self_employed
0      0          0        1              0
1      0          0        0              0
2      0          0        0              0
3      1          0        0              0
4      1          0        0              0

[5 rows x 40 columns]
</code></pre></div><pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">X_df = data.drop('PaidLoan', axis=1)
y_df = data['PaidLoan']
y_df.describe()
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">count     58003
unique        2
top        True
freq      29219
Name: PaidLoan, dtype: object
</code></pre></div><pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">from sklearn.model_selection import train_test_split
train_x, test_x, train_y, test_y = train_test_split(X_df, y_df, test_size=0.25, random_state=42)
</code></pre><p>Runs a grid search to find the tuning parameters that maxisimise the area under the curve (AUC) train_x is the training data frame with loan details and train_y is the default target column for training The method returns the best parameters and corresponding AUC score.</p>
<pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">from sklearn.model_selection import GridSearchCV
from xgboost.sklearn import XGBClassifier
from typing import Tuple

def find_best_xgboost_model(train_x: pd.DataFrame, train_y: pd.Series) -&gt; Tuple[dict, float]:
    scale_pos_weight = (len(train_y) - train_y.sum()) / train_y.sum()

    param_test = {
            'max_depth': [1, 2, 4, 8],
            'learning_rate': [0.05, 0.06, 0.07],
            'n_estimators': [10, 100, 200]
        }

    gsearch = GridSearchCV(estimator=XGBClassifier(
        objective='binary:logistic',
        scale_pos_weight=scale_pos_weight,
        seed=27),
        param_grid=param_test, scoring='roc_auc', n_jobs=-1, cv=8)

    gsearch.fit(train_x, train_y)

    return gsearch.best_params_, gsearch.best_score_
best_params, best_score = find_best_xgboost_model(train_x, train_y)
</code></pre><p>Using the xgboost model parameters, it predicts the probabilities of defaulting.</p>
<ul>
<li><code>best_params_</code>, best tuning parameters</li>
<li><code>train_x</code>, training dataframe with loan details</li>
<li><code>train_y</code>, default target column for training</li>
<li><code>test_x</code>, testing dataframe with loan details</li>
<li><code>test_y</code>, default target column for testing</li>
</ul>
<p>The result is a series of probabilities whether loan entry will default or not and corresponding model&rsquo;s AUC score</p>
<pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">from sklearn.metrics import roc_auc_score

def xgboost_predict(best_params_: dict, train_x: pd.DataFrame, train_y: pd.Series, test_x: pd.DataFrame,
                    test_y: pd.Series) -&gt; Tuple[list, float]:
    scale_pos_weight = (len(train_y) - train_y.sum()) / train_y.sum()
    xgb_model = XGBClassifier(objective='binary:logistic',
                              scale_pos_weight=scale_pos_weight,
                              seed=27,
                              max_depth=best_params_['max_depth'],
                              learning_rate=best_params_['learning_rate'],
                              n_estimators=best_params_['n_estimators']
                              )

    xgb_model.fit(train_x, train_y)
    predicted_probabilities_ = xgb_model.predict_proba(test_x)[:, 1]
    auc_ = roc_auc_score(test_y, predicted_probabilities_)

    return predicted_probabilities_, auc_
predicted_probabilities, auc = xgboost_predict(best_params, train_x, train_y, test_x, test_y)
print(&quot;AUC: {}&quot;.format(auc))
</code></pre><p>Filters the original loan dataframe to just include the loans from the test dataframe and then it adds the predicted probabilities.</p>
<ul>
<li><code>loans_df_</code>, original loan dataframe</li>
<li><code>test_index</code>, indices from the test dataframes</li>
<li><code>predicted_probabilities_</code>, the probabilities forecasted by the XGBoost model</li>
</ul>
<p>Returns the loans dataframe with predictions</p>
<pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">import numpy as np

def prepare_test_with_predictions(loans_df_: pd.DataFrame, test_index: pd.Index, predicted_probabilities_: np.array)\
        -&gt;pd.DataFrame:
    loan_test_df = loans_df_.loc[test_index]
    loan_test_df['predicted_probabilities'] = predicted_probabilities_
    return loan_test_df
loans_with_predictions_df = prepare_test_with_predictions(data, test_x.index, predicted_probabilities)
loans_with_predictions_df.head()
</code></pre><h2 id="visualisation">Visualisation</h2>
<pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">import seaborn as sns

sns.histplot(loans_with_predictions_df['predicted_probabilities'], stat='density')
</code></pre><h2 id="roc-and-auc">ROC and AUC</h2>
<p>Based on actuals and predicted values, it calculates their false positive rate (fpr), the true positive rate (tpr). It also returns the corresponding thresholds used as well as the value for the area under the curve.</p>
<p>actuals, series of actual values indicating whether the loan defaulted or not
predicted_probabilities, series of predicted probabilities of the loan defaulting
Return a unique series of false and true positive rates with corresponding series of thresholds and value for total area under the curve.</p>
<pre tabindex="0"><code class="language-jupyter-python" data-lang="jupyter-python">from sklearn.metrics import roc_curve, auc

def get_roc_auc_data(actuals: pd.Series, predicted_probabilities: pd.Series) -&gt; \
        Tuple[np.array, np.array, np.array, float]:
    fpr, tpr, thresholds = roc_curve(actuals, predicted_probabilities, pos_label=1)
    auc_score = auc(fpr, tpr)
    return fpr, tpr, thresholds, auc_score
fpr, tpr, thresholds, auc_score = get_roc_auc_data(loans_with_predictions_df['PaidLoan'], loans_with_predictions_df['predicted_probabilities'])
sns.lineplot(fpr)
</code></pre>
    </div>
  </article>



  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/map/">All pages</a></li>
         
          <li><a href="/search.html">Search</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#example">Example</a></li>
    <li><a href="#visualisation">Visualisation</a></li>
    <li><a href="#roc-and-auc">ROC and AUC</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=http%3a%2f%2fruivieira.dev%2fxgboost.html" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&text=XGBoost" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&title=XGBoost" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&is_video=false&description=XGBoost" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=XGBoost&body=Check out this article: http%3a%2f%2fruivieira.dev%2fxgboost.html" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&title=XGBoost" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&title=XGBoost" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=http%3a%2f%2fruivieira.dev%2fxgboost.html&name=XGBoost&description=Introduction%20Example%20Training%20XGBoost%20with%20the%20credit-bias%20dataset.%0aimport%20pandas%20as%20pd%20data%20%3d%20pd.read_csv%28%26quot%3bdata%2fcredit-bias-train.zip%26quot%3b%29%20data.head%28%29%20NewCreditCustomer%20Amount%20Interest%20LoanDuration%20Education%20%5c%200%20False%202125.0%2020.97%2060%204.0%201%20False%203000.0%2017.12%2060%205.0%202%20True%209100.0%2013.67%2060%204.0%203%20True%20635.0%2042.66%2060%202.0%204%20False%205000.0%2024.52%2060%204.0%20NrOfDependants%20EmploymentDurationCurrentEmployer%20%5c%200%200.0%206.0%201%200.0%206.0%202%201.0%203.0%203%200.0%201.0%204%201.0%205.0%20IncomeFromPrincipalEmployer%20IncomeFromPension%20IncomeFromFamilyAllowance%20%5c%200%200." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2fruivieira.dev%2fxgboost.html&t=XGBoost" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Rui Vieira 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/map/">All pages</a></li>
         
        <li><a href="/search.html">Search</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/css/fa.min.css>
<script src=/js/jquery-3.6.0.min.js></script>
<script src=/js/main.js></script>



  


<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</html>
